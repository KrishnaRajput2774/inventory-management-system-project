<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{_layout}">

<head>
    <title>Products</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <style>
        /* Glass-morphism and modern effects */
        .glass-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .metric-card:hover {
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.25);
        }

        .products-card {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }

        .in-stock-card {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        }

        .low-stock-card {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }

        .critical-card {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .animate-fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced product cards */
        .product-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .product-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, #4f46e5, #06b6d4);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .product-card:hover::before {
            opacity: 1;
        }

        .product-card:hover {
            transform: translateY(-4px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            border-color: #4f46e5;
        }

        /* Product header backgrounds */
        .stock-high { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
        .stock-medium { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }
        .stock-low { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        .stock-none { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }

        /* Search and filter styles */
        .filter-controls {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 12px;
        }

        .search-wrapper {
            position: relative;
        }

        .search-input {
            width: 100%;
            padding: 6px 8px 6px 30px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 10px;
            transition: all 0.3s ease;
            background: white;
        }

        .search-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
        }

        .clear-search {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            cursor: pointer;
            padding: 4px;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .clear-search:hover {
            color: #374151;
            background: rgba(243, 244, 246, 0.8);
        }

        .filter-button {
            padding: 5px 10px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 10px;
        }

        .filter-button:hover {
            border-color: #4f46e5;
            background: #f9fafb;
        }

        .filter-button.active {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border-color: transparent;
        }

        .sort-select {
            padding: 5px 8px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            font-weight: 600;
            font-size: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .sort-select:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        /* Info badges */
        .info-badge {
            display: inline-flex;
            align-items: center;
            padding: 2px 6px;
            border-radius: 8px;
            font-size: 8px;
            font-weight: 600;
        }

        .category-badge {
            background: rgba(59, 130, 246, 0.1);
            color: #1d4ed8;
            border: 1px solid rgba(59, 130, 246, 0.2);
        }

        .supplier-badge {
            background: rgba(139, 92, 246, 0.1);
            color: #7c3aed;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .stock-badge {
            padding: 3px 4px;
            border-radius: 6px;
            font-size: 7px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Buttons */
        .btn-primary {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 6px 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            box-shadow: 0 4px 14px 0 rgba(79, 70, 229, 0.4);
            text-decoration: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #4338ca 0%, #6d28d9 100%);
            transform: translateY(-2px) scale(1.02);
            box-shadow: 0 8px 25px 0 rgba(79, 70, 229, 0.6);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.9);
            color: #374151;
            border: 2px solid rgba(209, 213, 219, 0.5);
            border-radius: 12px;
            padding: 5px 10px;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            text-decoration: none;
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 1);
            color: #111827;
            transform: translateY(-2px);
            box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.1);
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-state-icon {
            width: 80px;
            height: 80px;
            margin: 0 auto 24px;
            background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: #9ca3af;
        }

        /* Loading state */
        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10;
            border-radius: 16px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #f3f4f6;
            border-top: 4px solid #4f46e5;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Utility classes */
        .line-clamp-2 {
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .compact-modal {
            max-width: 800px !important;
            width: 90vw;
            max-height: 400px;
        }

        .compact-btn {
            padding: 0.5rem 1rem !important;
            font-size: 0.875rem !important;
            min-width: auto !important;
        }

        .line-clamp-4 {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* Ensure glass-card maintains its styling */
        .glass-card {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* Modal base styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            backdrop-filter: blur(4px);
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            max-width: 90vw;
            max-height: 90vh;
            overflow: auto;
        }

        .btn-primary-modal {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            font-weight: 600;
            transition: all 0.2s;
        }

        .btn-secondary-modal {
            background: #f3f4f6;
            color: #374151;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            border: none;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-secondary-modal:hover {
            background: #e5e7eb;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .compact-modal {
                max-width: 95vw !important;
                max-height: 80vh;
            }

            .grid-cols-3 {
                grid-template-columns: 1fr !important;
            }

            .col-span-1 {
                grid-column: span 1 / span 1 !important;
            }
        }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
<div layout:fragment="content">

    <!-- Header Section -->
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-4 mb-8">
        <div class="animate-fade-in">
            <h1 class="text-2xl font-bold text-gray-900 mb-3">Products</h1>
            <p class="text-base text-gray-600">Manage your product inventory with smart search and filtering</p>
        </div>
        <div class="flex flex-wrap gap-2 animate-fade-in">
            <a href="/products/create" class="btn-primary">
                <i class="bi bi-plus-circle mr-1"></i>Add Product
            </a>
            <a href="/dashboard" class="btn-secondary">
                <i class="bi bi-arrow-left mr-1"></i>Back to Dashboard
            </a>
        </div>
    </div>

    <!-- Statistics Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3 mb-8">
        <!-- Total Products -->
        <div class="metric-card products-card rounded-2xl text-white p-4 shadow-2xl animate-fade-in">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-xs font-medium uppercase tracking-wide">Total Products</p>
                    <p class="text-2xl font-bold mt-2" th:text="${totalProducts ?: 0}">0</p>
                    <div class="flex items-center mt-3">
                        <i class="bi bi-box text-white/60 mr-2"></i>
                        <span class="text-white/80 text-sm">Items</span>
                    </div>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="bi bi-boxes text-lg"></i>
                </div>
            </div>
        </div>

        <!-- In Stock -->
        <div class="metric-card in-stock-card rounded-2xl text-white p-4 shadow-2xl animate-fade-in" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-xs font-medium uppercase tracking-wide">In Stock</p>
                    <p class="text-2xl font-bold mt-2" th:text="${inStockProducts ?: 0}">0</p>
                    <div class="flex items-center mt-3">
                        <i class="bi bi-check-circle text-white/60 mr-2"></i>
                        <span class="text-white/80 text-sm">Available</span>
                    </div>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="bi bi-check-circle-fill text-lg"></i>
                </div>
            </div>
        </div>

        <!-- Low Stock -->
        <div class="metric-card low-stock-card rounded-2xl text-white p-4 shadow-2xl animate-fade-in" style="animation-delay: 0.2s;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-xs font-medium uppercase tracking-wide">Low Stock</p>
                    <p class="text-2xl font-bold mt-2" th:text="${lowStockProducts ?: 0}">0</p>
                    <div class="flex items-center mt-3">
                        <i class="bi bi-exclamation-triangle text-white/60 mr-2"></i>
                        <span class="text-white/80 text-sm">Warning</span>
                    </div>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="bi bi-exclamation-triangle-fill text-lg"></i>
                </div>
            </div>
        </div>

        <!-- Critical Stock -->
        <div class="metric-card critical-card rounded-2xl text-white p-4 shadow-2xl animate-fade-in" style="animation-delay: 0.3s;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-xs font-medium uppercase tracking-wide">Critical Stock</p>
                    <p class="text-2xl font-bold mt-2" th:text="${criticalStockProducts ?: 0}">0</p>
                    <div class="flex items-center mt-3">
                        <i class="bi bi-x-circle text-white/60 mr-2"></i>
                        <span class="text-white/80 text-sm">Urgent</span>
                    </div>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="bi bi-x-circle-fill text-lg"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Search and Filter Controls -->
    <div class="glass-card rounded-2xl shadow-2xl mb-8 animate-fade-in" style="animation-delay: 0.4s;">
        <div class="filter-controls">
            <!-- Search Bar -->
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2 mb-2">
                <div class="flex-1 max-w-md">
                    <div class="search-wrapper">
                        <i class="bi bi-search search-icon text-sm ml-[-6px]"></i>
                        <input type="text"
                               id="productSearch"
                               class="search-input"
                               placeholder="Search products by name, brand, category, code..."
                               autocomplete="off">
                        <button class="clear-search" id="clearSearch" style="display: none;">
                            <i class="bi bi-x text-lg"></i>
                        </button>
                    </div>
                    <div id="searchFeedback" class="text-xs text-gray-500 mt-2"></div>
                </div>

                <div class="flex items-center gap-3">
                    <select id="sortSelect" class="sort-select">
                        <option value="name-asc">Name A-Z</option>
                        <option value="name-desc">Name Z-A</option>
                        <option value="stock-low">Stock: Low to High</option>
                        <option value="stock-high">Stock: High to Low</option>
                        <option value="price-low">Price: Low to High</option>
                        <option value="price-high">Price: High to Low</option>
                    </select>
                </div>
            </div>

            <!-- Quick Filters -->
            <div class="flex flex-wrap gap-3">
                <button class="filter-button active" data-filter="all">All Products</button>
                <button class="filter-button" data-filter="in-stock">In Stock (50+)</button>
                <button class="filter-button" data-filter="low-stock">Low Stock (10-49)</button>
                <button class="filter-button" data-filter="critical">Critical (0-9)</button>
            </div>
        </div>
    </div>

    <!-- Products Grid -->
    <div class="glass-card rounded-2xl shadow-2xl animate-fade-in" style="animation-delay: 0.5s;">
        <div class="px-3 py-2 border-b border-gray-200/30">
            <div class="flex items-center justify-between">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Products</h3>
                    <p class="text-sm text-gray-600 mt-1">
                        Showing <span id="resultCount" th:text="${#lists.size(products)}">0</span> products
                    </p>
                </div>
            </div>
        </div>

        <div class="p-6 relative">
            <!-- Loading Overlay -->
            <div id="loadingOverlay" class="loading-overlay" style="display: none;">
                <div class="text-center">
                    <div class="spinner"></div>
                    <p class="mt-4 text-gray-600 font-medium">Searching products...</p>
                </div>
            </div>

            <!-- Products Grid -->
            <div id="productsGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 xl:grid-cols-4 gap-3">
                <div th:each="product : ${products}"
                     class="product-card rounded-2xl shadow-lg overflow-hidden"
                     th:data-product-id="${product.productId}"
                     th:data-name="${product.name ?: ''}"
                     th:data-brand="${product.brandName ?: ''}"
                     th:data-category="${product.category?.name ?: ''}"
                     th:data-supplier="${product.supplier?.name ?: ''}"
                     th:data-stock="${product.stockQuantity ?: 0}"
                     th:data-selling-price="${product.sellingPrice ?: 0}"
                     th:data-actual-price="${product.actualPrice ?: 0}"
                     th:data-description="${product.description ?: ''}"
                     th:data-product-code="${product.productCode ?: ''}">

                    <!-- Product Header with Dynamic Background -->
                    <div class="relative p-3 text-white"
                         th:classappend="${product.stockQuantity >= 50 ? 'stock-high' :
                         (product.stockQuantity >= 10 ? 'stock-medium' :
                         (product.stockQuantity >= 1 ? 'stock-low' : 'stock-none'))}">
                        <div class="flex items-center justify-between mb-1">
                            <div class="w-8 h-8 bg-white/20 rounded-xl flex items-center justify-center">
                                <i class="bi bi-box text-2xl"></i>
                            </div>
                            <div class="text-right">
                                <span class="stock-badge bg-white/20 text-white" th:text="${product.stockQuantity} + ' units'">0 units</span>
                                <div class="text-[9px] mt-1 opacity-80" th:text="${product.productCode}">CODE</div>
                            </div>
                        </div>
                        <h3 class="text-base font-bold mb-1 line-clamp-2" th:text="${product.name}">Product Name</h3>
                        <p class="text-sm opacity-80" th:text="${product.brandName ?: 'No Brand'}">Brand Name</p>
                    </div>

                    <!-- Product Details -->
                    <div class="p-3">
                        <!-- Category and Supplier Tags -->
                        <div class="flex flex-wrap gap-1 mb-2">
                            <span class="info-badge category-badge">
                                <i class="bi bi-tag mr-1"></i>
                                <span th:text="${product.category?.name ?: 'Uncategorized'}">Category</span>
                            </span>
                            <span class="info-badge supplier-badge">
                                <i class="bi bi-building mr-0.5"></i>
                                <span th:text="${product.supplier?.name ?: 'No Supplier'}">Supplier</span>
                            </span>
                        </div>

                        <!-- Description -->
                        <p class="text-xs text-gray-600 mb-2 line-clamp-2"
                           th:text="${product.description?.isEmpty() ? 'No description available' : product.description}">
                            Product description...
                        </p>

                        <!-- Pricing -->
                        <div class="flex items-center justify-between mb-1.5 p-1.5 bg-gray-50 rounded-xl">
                            <div>
                                <p class="text-xs text-gray-500 mb-1">Selling Price</p>
                                <p class="text-sm font-bold text-gray-900" th:text="'₹' + ${#numbers.formatDecimal(product.sellingPrice ?: 0, 1, 2)}">₹0</p>
                            </div>
                            <div class="text-right">
                                <p class="text-xs text-gray-500 mb-1">Cost Price</p>
                                <p class="text-xs text-gray-600 line-through" th:text="'₹' + ${#numbers.formatDecimal(product.actualPrice ?: 0, 1, 2)}">₹0</p>
                                <p class="text-xs font-bold text-green-600 mt-1" th:text="'₹' + ${#numbers.formatDecimal((product.sellingPrice ?: 0) - (product.actualPrice ?: 0), 1, 2)} + ' profit'">₹0 profit</p>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-1">
                            <a th:href="@{/products/{id}(id=${product.productId})}"
                               class="flex-1 btn-primary text-xs py-1 px-1.5">
                                <i class="bi bi-eye mr-1"></i>View
                            </a>
                            <a th:href="@{/products/{id}/stock(id=${product.productId})}"
                               class="btn-secondary text-xs py-1 px-1.5">
                                <i class="bi bi-box mr-1"></i>Stock
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Empty State -->
            <div id="emptyState" class="empty-state" style="display: none;">
                <div class="empty-state-icon">
                    <i class="bi bi-search"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">No products found</h3>
                <p class="text-gray-600 mb-6">Try adjusting your search criteria or filters</p>
                <button class="btn-primary" onclick="clearAllFilters()">
                    <i class="bi bi-arrow-clockwise mr-2"></i>Clear Filters
                </button>
            </div>

            <!-- No Products State (when no products exist) -->
            <div th:if="${#lists.isEmpty(products)}" class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-box"></i>
                </div>
                <h3 class="text-xl font-bold text-gray-900 mb-2">No products available</h3>
                <p class="text-gray-600 mb-6">Get started by adding your first product to the inventory</p>
                <a href="/products/create" class="btn-primary">
                    <i class="bi bi-plus mr-2"></i>Create First Product
                </a>
            </div>
        </div>
    </div>

    <!-- Product Detail Modal -->
    <div id="productModal" class="modal">
        <div class="modal-content compact-modal">
            <div class="flex items-center justify-between p-4 border-b border-gray-200/30">
                <h5 class="text-lg font-bold text-gray-900" id="modalTitle">Product Details</h5>
                <button type="button" class="text-gray-400 hover:text-gray-600 text-xl leading-none" onclick="closeModal()">×</button>
            </div>

            <div class="p-4">
                <!-- Main Content Grid - Horizontal Layout -->
                <div class="grid grid-cols-3 gap-4">
                    <!-- Left Column: Product Header -->
                    <div class="col-span-1">
                        <div id="modalHeader" class="text-center p-3 rounded-xl text-white h-full flex flex-col justify-center">
                            <div class="w-8 h-8 bg-white/20 rounded-lg flex items-center justify-center mx-auto mb-2">
                                <i class="bi bi-box text-sm"></i>
                            </div>
                            <h4 class="text-lg font-bold mb-1" id="modalProductName"></h4>
                            <p class="text-sm opacity-90" id="modalBrand"></p>
                            <p class="text-xs opacity-75 mt-1" id="modalProductCode"></p>
                        </div>
                    </div>

                    <!-- Middle Column: Info Cards -->
                    <div class="col-span-1 space-y-3">
                        <!-- Category & Supplier -->
                        <div class="grid grid-cols-1 gap-2">
                            <div class="glass-card rounded-lg p-2 text-center">
                                <p class="text-xs text-gray-500 mb-1">Category</p>
                                <p class="font-bold text-sm text-gray-900" id="modalCategory"></p>
                            </div>
                            <div class="glass-card rounded-lg p-2 text-center">
                                <p class="text-xs text-gray-500 mb-1">Supplier</p>
                                <p class="font-bold text-sm text-gray-900" id="modalSupplier"></p>
                            </div>
                        </div>

                        <!-- Stock Info -->
                        <div class="glass-card rounded-lg p-2 text-center">
                            <p class="text-xs text-gray-500 mb-1">Stock Quantity</p>
                            <p class="text-lg font-bold mb-1" id="modalStock"></p>
                            <div id="modalStockBadge" class="inline-block px-2 py-0.5 rounded-full text-xs font-bold"></div>
                        </div>
                    </div>

                    <!-- Right Column: Pricing & Description -->
                    <div class="col-span-1 space-y-3">
                        <!-- Pricing Info -->
                        <div class="glass-card rounded-lg p-2">
                            <div class="grid grid-cols-1 gap-2 text-center">
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">Selling Price</p>
                                    <p class="text-sm font-bold text-gray-900" id="modalSellingPrice"></p>
                                </div>
                                <div>
                                    <p class="text-xs text-gray-500 mb-1">Cost Price</p>
                                    <p class="text-sm text-gray-600" id="modalActualPrice"></p>
                                </div>
                            </div>
                            <div class="text-center mt-2">
                                <div class="inline-block px-2 py-1 bg-green-100 text-green-800 rounded-lg text-xs font-bold" id="modalProfit"></div>
                            </div>
                        </div>

                        <!-- Description -->
                        <div class="glass-card rounded-lg p-3 flex-1">
                            <h6 class="text-xs font-bold text-gray-700 mb-1 uppercase tracking-wide">Description</h6>
                            <p class="text-xs text-gray-600 line-clamp-4" id="modalDescription"></p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Footer Actions -->
            <div class="flex gap-2 p-3 border-t border-gray-200/30 bg-gray-50/50">
                <button type="button" class="btn-secondary-modal compact-btn" onclick="closeModal()">Close</button>
                <a id="modalViewLink" class="btn-primary-modal compact-btn">
                    <i class="bi bi-eye mr-1"></i>View
                </a>
                <a id="modalStockLink" class="btn-primary-modal compact-btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                    <i class="bi bi-box mr-1"></i>Stock
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Fixed JavaScript Implementation -->
<th:block layout:fragment="scripts">
    <script>
        // Product Management System - Fixed Implementation
        class ProductManager {
            constructor() {
                this.allProducts = [];
                this.filteredProducts = [];
                this.currentFilter = 'all';
                this.currentSort = 'name-asc';
                this.searchTerm = '';

                // Initialize when DOM is ready
                if (document.readyState === 'loading') {
                    document.addEventListener('DOMContentLoaded', () => this.init());
                } else {
                    this.init();
                }
            }

            init() {
                console.log('Initializing Product Manager...');
                this.initializeProducts();
                this.setupEventListeners();
                console.log('Product Manager initialized with', this.allProducts.length, 'products');
            }

            initializeProducts() {
                const productCards = document.querySelectorAll('.product-card');
                this.allProducts = Array.from(productCards).map(card => ({
                    element: card,
                    id: card.dataset.productId,
                    name: (card.dataset.name || '').toLowerCase(),
                    brand: (card.dataset.brand || '').toLowerCase(),
                    category: (card.dataset.category || '').toLowerCase(),
                    supplier: (card.dataset.supplier || '').toLowerCase(),
                    stock: parseInt(card.dataset.stock || 0),
                    sellingPrice: parseFloat(card.dataset.sellingPrice || 0),
                    actualPrice: parseFloat(card.dataset.actualPrice || 0),
                    description: (card.dataset.description || '').toLowerCase(),
                    productCode: (card.dataset.productCode || '').toLowerCase()
                }));

                this.filteredProducts = [...this.allProducts];
                this.updateResultCount();

                // Add click event to each product card for modal
                productCards.forEach(card => {
                    card.addEventListener('click', (e) => {
                        // Don't open modal if clicking on buttons or links
                        if (e.target.closest('a, button')) {
                            return;
                        }
                        this.openProductModal(card);
                    });
                });
            }

            setupEventListeners() {
                // Search functionality
                const searchInput = document.getElementById('productSearch');
                const clearSearchBtn = document.getElementById('clearSearch');

                if (searchInput) {
                    searchInput.addEventListener('input', (e) => this.handleSearch(e));
                }

                if (clearSearchBtn) {
                    clearSearchBtn.addEventListener('click', () => this.clearSearch());
                }

                // Filter buttons
                const filterButtons = document.querySelectorAll('.filter-button');
                filterButtons.forEach(button => {
                    button.addEventListener('click', (e) => this.handleFilter(e));
                });

                // Sort dropdown
                const sortSelect = document.getElementById('sortSelect');
                if (sortSelect) {
                    sortSelect.addEventListener('change', (e) => this.handleSort(e));
                }

                // Modal close events
                const modal = document.getElementById('productModal');
                if (modal) {
                    modal.addEventListener('click', (e) => {
                        if (e.target === modal) {
                            this.closeModal();
                        }
                    });
                }

                // Close modal on Escape key
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeModal();
                    }
                });
            }

            handleSearch(e) {
                this.searchTerm = e.target.value.toLowerCase().trim();
                const clearBtn = document.getElementById('clearSearch');

                // Show/hide clear button
                if (clearBtn) {
                    clearBtn.style.display = this.searchTerm ? 'block' : 'none';
                }

                // Debounce search
                clearTimeout(this.searchTimeout);
                this.searchTimeout = setTimeout(() => {
                    this.applyFilters();
                    this.updateSearchFeedback();
                }, 300);
            }

            clearSearch() {
                const searchInput = document.getElementById('productSearch');
                const clearBtn = document.getElementById('clearSearch');

                if (searchInput) {
                    searchInput.value = '';
                    this.searchTerm = '';
                }

                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }

                this.applyFilters();
                this.updateSearchFeedback();

                if (searchInput) {
                    searchInput.focus();
                }
            }

            handleFilter(e) {
                const button = e.target;
                this.currentFilter = button.dataset.filter;

                // Update active state
                document.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                });
                button.classList.add('active');

                this.applyFilters();
            }

            handleSort(e) {
                this.currentSort = e.target.value;
                this.applyFilters();
            }

            applyFilters() {
                this.showLoading(true);

                setTimeout(() => {
                    // Apply search and filter
                    this.filteredProducts = this.allProducts.filter(product => {
                        // Search filter
                        if (this.searchTerm) {
                            const searchableText = [
                                product.name,
                                product.brand,
                                product.category,
                                product.supplier,
                                product.description,
                                product.productCode
                            ].join(' ');

                            if (!searchableText.includes(this.searchTerm)) {
                                return false;
                            }
                        }

                        // Stock filter
                        switch (this.currentFilter) {
                            case 'in-stock':
                                return product.stock >= 50;
                            case 'low-stock':
                                return product.stock >= 10 && product.stock < 50;
                            case 'critical':
                                return product.stock < 10;
                            default:
                                return true;
                        }
                    });

                    // Apply sorting
                    this.sortProducts();
                    this.updateDisplay();
                    this.showLoading(false);
                }, 200);
            }

            sortProducts() {
                switch (this.currentSort) {
                    case 'name-asc':
                        this.filteredProducts.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'name-desc':
                        this.filteredProducts.sort((a, b) => b.name.localeCompare(a.name));
                        break;
                    case 'stock-low':
                        this.filteredProducts.sort((a, b) => a.stock - b.stock);
                        break;
                    case 'stock-high':
                        this.filteredProducts.sort((a, b) => b.stock - a.stock);
                        break;
                    case 'price-low':
                        this.filteredProducts.sort((a, b) => a.sellingPrice - b.sellingPrice);
                        break;
                    case 'price-high':
                        this.filteredProducts.sort((a, b) => b.sellingPrice - a.sellingPrice);
                        break;
                }
            }

            updateDisplay() {
                const emptyState = document.getElementById('emptyState');
                const productsGrid = document.getElementById('productsGrid');

                // Hide all products first
                this.allProducts.forEach(product => {
                    product.element.style.display = 'none';
                });

                if (this.filteredProducts.length === 0) {
                    if (emptyState) {
                        emptyState.style.display = 'block';
                    }
                } else {
                    if (emptyState) {
                        emptyState.style.display = 'none';
                    }

                    // Show filtered and sorted products
                    this.filteredProducts.forEach((product, index) => {
                        product.element.style.display = 'block';
                        // Reorder in DOM to reflect sort
                        if (productsGrid) {
                            productsGrid.appendChild(product.element);
                        }
                    });
                }

                this.updateResultCount();
            }

            updateResultCount() {
                const resultCount = document.getElementById('resultCount');
                if (resultCount) {
                    resultCount.textContent = this.filteredProducts.length;
                }
            }

            updateSearchFeedback() {
                const feedback = document.getElementById('searchFeedback');
                if (feedback) {
                    if (this.searchTerm) {
                        feedback.textContent = `${this.filteredProducts.length} products found`;
                        feedback.className = 'text-xs text-blue-600 font-medium mt-2';
                    } else {
                        feedback.textContent = '';
                    }
                }
            }

            clearAllFilters() {
                // Reset all filters
                this.searchTerm = '';
                this.currentFilter = 'all';
                this.currentSort = 'name-asc';

                // Reset UI
                const searchInput = document.getElementById('productSearch');
                if (searchInput) {
                    searchInput.value = '';
                }

                const clearBtn = document.getElementById('clearSearch');
                if (clearBtn) {
                    clearBtn.style.display = 'none';
                }

                const sortSelect = document.getElementById('sortSelect');
                if (sortSelect) {
                    sortSelect.value = 'name-asc';
                }

                // Reset filter buttons
                document.querySelectorAll('.filter-button').forEach(btn => {
                    btn.classList.remove('active');
                    if (btn.dataset.filter === 'all') {
                        btn.classList.add('active');
                    }
                });

                this.applyFilters();
                this.updateSearchFeedback();
            }

            showLoading(show) {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) {
                    overlay.style.display = show ? 'flex' : 'none';
                }
            }

            openProductModal(card) {
                const modal = document.getElementById('productModal');
                if (!modal) return;

                const productData = {
                    id: card.dataset.productId,
                    name: card.dataset.name || '',
                    brand: card.dataset.brand || 'No Brand',
                    category: card.dataset.category || 'Uncategorized',
                    supplier: card.dataset.supplier || 'No Supplier',
                    stock: parseInt(card.dataset.stock || 0),
                    sellingPrice: parseFloat(card.dataset.sellingPrice || 0),
                    actualPrice: parseFloat(card.dataset.actualPrice || 0),
                    description: card.dataset.description || 'No description available',
                    productCode: card.dataset.productCode || 'N/A'
                };

                // Populate modal
                document.getElementById('modalTitle').textContent = productData.name;
                document.getElementById('modalProductName').textContent = productData.name;
                document.getElementById('modalBrand').textContent = productData.brand;
                document.getElementById('modalProductCode').textContent = `Code: ${productData.productCode}`;
                document.getElementById('modalCategory').textContent = productData.category;
                document.getElementById('modalSupplier').textContent = productData.supplier;
                document.getElementById('modalStock').textContent = productData.stock;
                document.getElementById('modalSellingPrice').textContent = `₹${productData.sellingPrice.toFixed(2)}`;
                document.getElementById('modalActualPrice').textContent = `₹${productData.actualPrice.toFixed(2)}`;
                document.getElementById('modalDescription').textContent = productData.description;

                const profit = productData.sellingPrice - productData.actualPrice;
                document.getElementById('modalProfit').textContent = `₹${profit.toFixed(2)} profit per unit`;

                // Update stock badge
                const stockBadge = document.getElementById('modalStockBadge');
                if (productData.stock >= 50) {
                    stockBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-bold bg-green-100 text-green-800';
                    stockBadge.textContent = 'In Stock';
                } else if (productData.stock >= 10) {
                    stockBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800';
                    stockBadge.textContent = 'Available';
                } else if (productData.stock > 0) {
                    stockBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-bold bg-yellow-100 text-yellow-800';
                    stockBadge.textContent = 'Low Stock';
                } else {
                    stockBadge.className = 'inline-block px-3 py-1 rounded-full text-sm font-bold bg-red-100 text-red-800';
                    stockBadge.textContent = 'Out of Stock';
                }

                // Update header background
                const modalHeader = document.getElementById('modalHeader');
                if (productData.stock >= 50) {
                    modalHeader.style.background = 'linear-gradient(135deg, #10b981 0%, #34d399 100%)';
                } else if (productData.stock >= 10) {
                    modalHeader.style.background = 'linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%)';
                } else if (productData.stock > 0) {
                    modalHeader.style.background = 'linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%)';
                } else {
                    modalHeader.style.background = 'linear-gradient(135deg, #ef4444 0%, #f87171 100%)';
                }

                // Update links
                document.getElementById('modalViewLink').href = `/products/${productData.id}`;
                document.getElementById('modalStockLink').href = `/products/${productData.id}/stock`;

                // Show modal with proper centering
                modal.classList.add('show');
            }

            closeModal() {
                const modal = document.getElementById('productModal');
                if (modal) {
                    modal.classList.remove('show');
                }
            }
        }

        // Initialize Product Manager
        const productManager = new ProductManager();

        // Global functions for use in HTML
        window.clearAllFilters = function() {
            productManager.clearAllFilters();
        };

        window.closeModal = function() {
            productManager.closeModal();
        };
    </script>
</th:block>

</body>
</html>