<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{_layout}">

<head>
    <title th:text="'Order #' + ${order.orderId}">Order Detail</title>
    <style>
        .metric-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .metric-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.15);
        }
        .profit-card {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        .loss-card {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
        }
        .revenue-card {
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
        }
        .cost-card {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }
        .margin-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
        }
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .order-icon {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
        }
        .customer-icon {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
        }
        .product-icon {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
        }
        .table-row:hover {
            background: rgba(59, 130, 246, 0.05);
            transition: background-color 0.2s ease;
        }
        .success-alert {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            color: white;
            border: none;
        }
        .error-alert {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            color: white;
            border: none;
        }
        .animate-fade-in {
            animation: fadeIn 0.6s ease-in-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        .status-completed { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
        .status-created { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
        .status-processing { background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%); }
        .status-cancelled { background: linear-gradient(135deg, #ef4444 0%, #f87171 100%); }
        .type-sale { background: linear-gradient(135deg, #10b981 0%, #34d399 100%); }
        .type-purchase { background: linear-gradient(135deg, #06b6d4 0%, #67e8f9 100%); }
        .type-return { background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%); }
    </style>
</head>

<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
<div layout:fragment="content">

    <!-- Flash Messages -->
    <div th:if="${successMessage}" class="success-alert rounded-xl p-3 mb-4 shadow-lg animate-fade-in">
        <div class="flex items-center">
            <i class="bi bi-check-circle-fill mr-3 text-lg"></i>
            <span th:text="${successMessage}"></span>
        </div>
    </div>
    <div th:if="${errorMessage}" class="error-alert rounded-xl p-3 mb-4 shadow-lg animate-fade-in">
        <div class="flex items-center">
            <i class="bi bi-exclamation-triangle-fill mr-3 text-lg"></i>
            <span th:text="${errorMessage}"></span>
        </div>
    </div>

    <!-- Header Section -->
    <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-3 mb-6">
        <div class="animate-fade-in">
            <h1 class="text-xl font-bold text-gray-900 mb-1" th:text="'Order #' + ${order.orderId}">Order Detail</h1>
            <p class="text-sm text-gray-600">Comprehensive order analysis with profit/loss insights</p>
        </div>
        <div class="flex flex-wrap gap-2 animate-fade-in">
            <form th:action="@{/invoices/download(orderIds=${order.orderId})}" method="get" style="display: inline;">
                <input type="hidden" name="orderIds" th:value="${order.orderId}">
                <button type="submit" class="bg-gradient-to-r from-purple-600 to-purple-700 text-white px-3 py-2 rounded-xl hover:shadow-xl transition-all duration-300 font-semibold pulse text-sm">
                    <i class="bi bi-file-earmark-pdf-fill mr-2"></i><span class="text-xs">Generate Invoice</span>
                </button>
            </form>
            <a th:href="@{/orders}"
               class="bg-gradient-to-r from-gray-600 to-gray-800 text-white px-3 py-2 rounded-xl hover:shadow-xl transition-all duration-300 font-semibold text-sm">
                <i class="bi bi-arrow-left mr-2"></i><span class="text-xs">Back to Orders</span>
            </a>
            <a th:if="${order.customer != null}"
               th:href="@{/customers/{id}/orders(id=${order.customer.customerId})}"
               class="bg-gradient-to-r from-blue-600 to-blue-700 text-white px-3 py-2 rounded-xl hover:shadow-xl transition-all duration-300 font-semibold text-sm">
                <i class="bi bi-person-fill mr-2"></i><span class="text-xs">Customer Orders</span>
            </a>
        </div>
    </div>

    <!-- Financial Analytics Dashboard -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3 mb-4">
        <!-- Total Revenue -->
        <div class="metric-card revenue-card rounded-2xl text-white p-4 shadow-2xl animate-fade-in">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-xs font-medium uppercase tracking-wide">Total Revenue</p>
                    <p class="text-lg font-bold mt-2" th:text="'₹' + ${#numbers.formatDecimal(order.totalPrice, 0, 2)}">₹0.00</p>
                    <div class="flex items-center mt-3">
                        <i class="bi bi-currency-rupee text-white/60 mr-2"></i>
                        <span class="text-white/80 text-xs">Selling Price</span>
                    </div>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="bi bi-graph-up text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Total Cost -->
        <div class="metric-card cost-card rounded-2xl text-white p-4 shadow-2xl animate-fade-in" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-xs font-medium uppercase tracking-wide">Total Cost</p>
                    <p class="text-lg font-bold mt-2" th:text="'₹' + ${#numbers.formatDecimal(totalCostPrice, 0, 2)}">₹0.00</p>
                    <div class="flex items-center mt-3">
                        <i class="bi bi-receipt text-white/60 mr-2"></i>
                        <span class="text-white/80 text-xs">Cost Price</span>
                    </div>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="bi bi-calculator text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Profit/Loss -->
        <div class="metric-card rounded-2xl text-white p-4 shadow-2xl animate-fade-in" style="animation-delay: 0.2s;"
             th:classappend="${totalProfitLoss >= 0 ? 'profit-card' : 'loss-card'}">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-xs font-medium uppercase tracking-wide">Profit/Loss</p>
                    <p class="text-lg font-bold mt-2" th:text="${totalProfitLoss >= 0 ? '+' : ''}+ '₹' + ${#numbers.formatDecimal(totalProfitLoss, 0, 2)}">₹0.00</p>
                    <div class="flex items-center mt-3">
                        <i th:class="${totalProfitLoss >= 0 ? 'bi bi-arrow-up' : 'bi bi-arrow-down'} + ' text-white/60 mr-2'"></i>
                        <span class="text-white/80 text-xs" th:text="${totalProfitLoss >= 0 ? 'Profitable' : 'Loss Making'}">Status</span>
                    </div>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i th:class="${totalProfitLoss >= 0 ? 'bi bi-trophy' : 'bi bi-exclamation-triangle'} + ' text-xl'"></i>
                </div>
            </div>
        </div>

        <!-- Profit Margin -->
        <div class="metric-card margin-card rounded-2xl text-white p-4 shadow-2xl animate-fade-in" style="animation-delay: 0.3s;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-xs font-medium uppercase tracking-wide">Profit Margin</p>
                    <p class="text-lg font-bold mt-2" th:text="${#numbers.formatDecimal(profitMargin, 0, 1)} + '%'">0.0%</p>
                    <div class="flex items-center mt-3">
                        <i class="bi bi-percent text-white/60 mr-2"></i>
                        <span class="text-white/80 text-xs">Efficiency</span>
                    </div>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="bi bi-speedometer2 text-xl"></i>
                </div>
            </div>
        </div>

        <!-- Items Count -->
        <div class="metric-card rounded-2xl text-white p-4 shadow-2xl animate-fade-in" style="animation-delay: 0.4s;">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-white/80 text-xs font-medium uppercase tracking-wide">Items</p>
                    <p class="text-lg font-bold mt-2" th:text="${#lists.size(order.orderItems)}">0</p>
                    <div class="flex items-center mt-3">
                        <i class="bi bi-box text-white/60 mr-2"></i>
                        <span class="text-white/80 text-xs">Products</span>
                    </div>
                </div>
                <div class="w-10 h-10 bg-white/20 rounded-2xl flex items-center justify-center">
                    <i class="bi bi-boxes text-xl"></i>
                </div>
            </div>
        </div>
    </div>

    <!-- Information Cards Grid -->
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

        <!-- Order Information Card -->
        <div class="glass-card rounded-2xl shadow-2xl p-4 animate-fade-in" style="animation-delay: 0.5s;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="bi bi-receipt-cutoff text-blue-600 mr-2"></i>Order Information
                </h3>
                <div class="w-8 h-8 order-icon rounded-xl flex items-center justify-center">
                    <i class="bi bi-file-earmark-text text-white text-sm"></i>
                </div>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Order ID</span>
                    <span class="text-sm font-bold text-blue-600" th:text="'#' + ${order.orderId}">#0</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Order Date</span>
                    <span class="text-xs font-bold text-gray-900" th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'MMM dd, yyyy') : 'N/A'}">N/A</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Order Type</span>
                    <span class="inline-flex px-2 py-1 text-[10px] font-bold rounded-full text-white"
                          th:classappend="'type-' + ${#strings.toLowerCase(order.orderType)}"
                          th:text="${order.orderType}">TYPE</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Status</span>
                    <span class="inline-flex px-2 py-1 text-[10px] font-bold rounded-full text-white"
                          th:classappend="'status-' + ${#strings.toLowerCase(order.orderStatus)}"
                          th:text="${order.orderStatus}">STATUS</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Payment Method</span>
                    <span class="text-xs font-bold text-gray-900" th:text="${order.paymentType}">CASH</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Created By</span>
                    <span class="text-xs font-bold text-gray-900">Admin</span>
                </div>
            </div>
        </div>

        <!-- Customer Information Card -->
        <div class="glass-card rounded-2xl shadow-2xl p-4 animate-fade-in" style="animation-delay: 0.6s;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="bi bi-person-fill text-green-600 mr-2"></i>Customer Details
                </h3>
                <div class="w-8 h-8 customer-icon rounded-xl flex items-center justify-center">
                    <i class="bi bi-person-check text-white text-sm"></i>
                </div>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Name</span>
                    <a th:href="@{/customers/{id}(id=${order.customer.customerId})}"
                       th:text="${order.customer.name}"
                       class="text-xs font-bold text-green-600 hover:text-green-800">Customer</a>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Email</span>
                    <a th:href="'mailto:' + ${order.customer.email}"
                       th:text="${order.customer.email}"
                       class="text-xs font-bold text-blue-600 hover:text-blue-800 truncate">email@example.com</a>
                </div>
                <div class="flex justify-between items-center p-2 bg-gray-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Contact</span>
                    <span class="text-xs font-bold text-gray-900" th:text="${order.customer.contactNumber}">+91 XXXXXXXXXX</span>
                </div>
                <div class="p-2 bg-gray-50 rounded-lg">
                    <span class="block text-xs font-medium text-gray-700 mb-2">Address</span>
                    <span class="text-xs font-bold text-gray-900" th:text="${order.customer.address ?: 'Not provided'}">Address details...</span>
                </div>
            </div>
        </div>

        <!-- Profit Analysis Card -->
        <div class="glass-card rounded-2xl shadow-2xl p-4 animate-fade-in" style="animation-delay: 0.7s;">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold text-gray-900">
                    <i class="bi bi-graph-up text-purple-600 mr-2"></i>Profit Analysis
                </h3>
                <div class="w-8 h-8 bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl flex items-center justify-center">
                    <i class="bi bi-analytics text-white text-sm"></i>
                </div>
            </div>
            <div class="space-y-3">
                <div class="flex justify-between items-center p-2 bg-green-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Profitable Items</span>
                    <span class="text-sm font-bold text-green-600" th:text="${profitableItemsCount}">0</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-red-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Loss Items</span>
                    <span class="text-sm font-bold text-red-600" th:text="${lossItemsCount}">0</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Avg Item Profit</span>
                    <span class="text-xs font-bold text-blue-600" th:text="'₹' + ${#numbers.formatDecimal(avgItemProfit ?: 0, 0, 2)}">₹0.00</span>
                </div>
                <div class="flex justify-between items-center p-2 bg-purple-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Performance</span>
                    <span class="text-xs font-bold"
                          th:classappend="${profitMargin >= 20 ? 'text-green-600' : (profitMargin >= 10 ? 'text-yellow-600' : 'text-red-600')}"
                          th:text="${profitMargin >= 20 ? 'Excellent' : (profitMargin >= 10 ? 'Good' : 'Poor')}">Status</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Items Analysis - Toggle Between Card and Table View -->
    <div class="glass-card rounded-2xl shadow-2xl animate-fade-in mb-6" style="animation-delay: 0.8s;">

        <!-- Header with View Toggle -->
        <div class="px-4 py-3 border-b border-gray-200/50 bg-gradient-to-r from-gray-50 to-gray-100">
            <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-2">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Order Items Analysis</h3>
                    <p class="text-xs text-gray-600">Detailed profit/loss breakdown for each product</p>
                </div>
                <div class="flex items-center space-x-3">
                    <!-- View Toggle Buttons -->
                    <div class="flex bg-gray-200 rounded-lg p-1">
                        <button id="cardViewBtn" class="px-3 py-1 text-xs font-medium rounded-md transition-all duration-200 bg-white text-gray-900 shadow-sm">
                            <i class="bi bi-grid-3x3-gap mr-1"></i>Cards
                        </button>
                        <button id="tableViewBtn" class="px-3 py-1 text-xs font-medium rounded-md transition-all duration-200 text-gray-600 hover:text-gray-900">
                            <i class="bi bi-table mr-1"></i>Table
                        </button>
                    </div>
                    <input type="text" id="itemSearch" placeholder="Search items..."
                           class="px-3 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-xs shadow-sm">
                    <div id="searchFeedback" class="text-xs text-gray-500"></div>
                </div>
            </div>
        </div>

        <!-- Card View (Default) -->
        <div id="cardView" class="p-4">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4" id="itemsGrid">
                <div th:each="item : ${order.orderItems}" class="bg-white border border-gray-200 rounded-xl p-4 hover:shadow-md transition-shadow duration-200 item-card">
                    <!-- Product Header -->
                    <div class="flex items-center justify-between mb-3">
                        <div class="flex items-center">
                            <div class="w-8 h-8 product-icon rounded-lg flex items-center justify-center mr-3">
                                <i class="bi bi-box text-white text-sm"></i>
                            </div>
                            <div>
                                <h4 class="font-semibold text-gray-900 text-sm">
                                    <a th:href="@{/products/{id}(id=${item.productDto.productId})}"
                                       th:text="${item.productDto.name}"
                                       class="hover:text-blue-600 transition-colors">Product Name</a>
                                </h4>
                                <p class="text-xs text-gray-500" th:text="${item.productDto.brandName}">Brand</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="inline-flex px-2 py-1 text-xs font-bold rounded-full bg-blue-100 text-blue-800" th:text="${item.quantity} + ' units'">0 units</span>
                        </div>
                    </div>

                    <!-- Financial Data Grid -->
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <!-- Cost vs Selling -->
                        <div class="bg-gray-50 rounded-lg p-2">
                            <div class="text-xs text-gray-600 mb-1">Unit Prices</div>
                            <div class="flex justify-between text-xs">
                                <span class="text-orange-600 font-medium">Cost: <span th:text="'₹' + ${#numbers.formatDecimal(item.productDto.actualPrice, 0, 0)}">₹0</span></span>
                                <span class="text-blue-600 font-medium">Sell: <span th:text="'₹' + ${#numbers.formatDecimal(item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime, 0, 0)}">₹0</span></span>
                            </div>
                        </div>

                        <!-- Profit Margin Badge -->
                        <div class="bg-gray-50 rounded-lg p-2 flex items-center justify-center">
                            <span class="inline-flex px-2 py-1 text-xs font-bold rounded-full text-white"
                                  th:classappend="${(((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) / item.productDto.actualPrice) * 100 >= 0 ? 'bg-green-500' : 'bg-red-500'}"
                                  th:text="${#numbers.formatDecimal((((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) / item.productDto.actualPrice) * 100, 0, 1)} + '% Margin'">0.0% Margin</span>
                        </div>
                    </div>

                    <!-- Total Analysis -->
                    <div class="border-t border-gray-100 pt-3">
                        <div class="flex justify-between items-center">
                            <div class="text-xs text-gray-600">
                                <div>Total Cost: <span class="font-medium text-gray-900" th:text="'₹' + ${#numbers.formatDecimal(item.productDto.actualPrice * item.quantity, 0, 0)}">₹0</span></div>
                                <div>Total Revenue: <span class="font-medium text-gray-900" th:text="'₹' + ${#numbers.formatDecimal((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) * item.quantity, 0, 0)}">₹0</span></div>
                            </div>
                            <div class="text-right">
                                <div class="text-xs text-gray-600 mb-1">Net Profit</div>
                                <div class="font-bold text-sm"
                                     th:classappend="${((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) * item.quantity >= 0 ? 'text-green-600' : 'text-red-600'}"
                                     th:text="${(((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) * item.quantity >= 0 ? '+' : '') + '₹' + #numbers.formatDecimal(((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) * item.quantity, 0, 0)}">₹0</div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Action -->
                    <div class="mt-3 pt-2 border-t border-gray-100">
                        <a th:href="@{/products/{id}(id=${item.productDto.productId})}"
                           class="inline-flex items-center text-xs text-blue-600 hover:text-blue-800 font-medium">
                            <i class="bi bi-eye mr-1"></i>View Product
                        </a>
                    </div>
                </div>
            </div>

            <!-- Summary Card -->
            <div class="mt-4 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-xl p-4">
                <h4 class="font-semibold text-gray-900 mb-3 text-sm">Order Summary</h4>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div class="text-center">
                        <div class="text-xs text-gray-600">Total Cost</div>
                        <div class="text-sm font-bold text-orange-600" th:text="'₹' + ${#numbers.formatDecimal(totalCostPrice, 0, 0)}">₹0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-600">Total Revenue</div>
                        <div class="text-sm font-bold text-blue-600" th:text="'₹' + ${#numbers.formatDecimal(order.totalPrice, 0, 0)}">₹0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-600">Net Profit</div>
                        <div class="text-sm font-bold"
                             th:classappend="${totalProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}"
                             th:text="${totalProfitLoss >= 0 ? '+' : ''} + '₹' + ${#numbers.formatDecimal(totalProfitLoss, 0, 0)}">₹0</div>
                    </div>
                    <div class="text-center">
                        <div class="text-xs text-gray-600">Profit Margin</div>
                        <div class="text-sm font-bold"
                             th:classappend="${profitMargin >= 0 ? 'text-green-600' : 'text-red-600'}"
                             th:text="${#numbers.formatDecimal(profitMargin, 0, 1)} + '%'">0.0%</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Table View (Hidden by default) -->
        <div id="tableView" class="hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50/80">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Product</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Brand</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Quantity</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Cost Price</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Selling Price</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Total Cost</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Total Selling</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Profit/Loss</th>
                        <th class="px-4 py-3 text-left text-xs font-bold text-gray-700 uppercase tracking-wider">Margin</th>
                        <th class="px-4 py-3 text-right text-xs font-bold text-gray-700 uppercase tracking-wider">Actions</th>
                    </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200/50" id="tableItemsBody">
                    <tr th:each="item : ${order.orderItems}" class="table-row item-row">
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <div class="w-10 h-10 product-icon rounded-xl flex items-center justify-center mr-4">
                                    <i class="bi bi-box text-white text-lg"></i>
                                </div>
                                <div>
                                    <div class="text-sm font-bold text-gray-900">
                                        <a th:href="@{/products/{id}(id=${item.productDto.productId})}"
                                           th:text="${item.productDto.name}"
                                           class="hover:text-blue-600 transition-colors duration-200">Product Name</a>
                                    </div>
                                    <div class="text-xs text-gray-500" th:text="'ID: ' + ${item.productDto.productId}">ID: 0</div>
                                </div>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900" th:text="${item.productDto.brandName}">Brand</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="flex items-center">
                                <span class="inline-flex items-center px-3 py-1 rounded-full text-sm font-bold bg-blue-100 text-blue-800"
                                      th:text="${item.quantity}">0</span>
                                <span class="ml-2 text-xs text-gray-500">units</span>
                            </div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900" th:text="'₹' + ${#numbers.formatDecimal(item.productDto.actualPrice, 0, 2)}">₹0.00</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900"
                                 th:text="'₹' + ${#numbers.formatDecimal(item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime, 0, 2)}">₹0.00</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-medium text-gray-900"
                                 th:text="'₹' + ${#numbers.formatDecimal(item.productDto.actualPrice * item.quantity, 0, 2)}">₹0.00</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-bold text-gray-900"
                                 th:text="'₹' + ${#numbers.formatDecimal((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) * item.quantity, 0, 2)}">₹0.00</div>
                        </td>
                        <td class="px-4 py-3">
                            <div class="text-sm font-bold"
                                 th:classappend="${((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) * item.quantity >= 0 ? 'text-green-600' : 'text-red-600'}"
                                 th:text="${(((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) * item.quantity >= 0 ? '+' : '') + '₹' + #numbers.formatDecimal(((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) * item.quantity, 0, 2)}">₹0.00</div>
                        </td>
                        <td class="px-4 py-3">
                            <span class="inline-flex px-2 py-1 text-xs font-bold rounded-full text-white"
                                  th:classappend="${(((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) / item.productDto.actualPrice) * 100 >= 0 ? 'bg-green-500' : 'bg-red-500'}"
                                  th:text="${#numbers.formatDecimal((((item.priceAtOrderTime == null ? item.productDto.sellingPrice : item.priceAtOrderTime) - item.productDto.actualPrice) / item.productDto.actualPrice) * 100, 0, 1)} + '%'">0.0%</span>
                        </td>
                        <td class="px-4 py-3 text-right">
                            <a th:href="@{/products/{id}(id=${item.productDto.productId})}"
                               class="inline-flex items-center px-3 py-2 text-xs font-semibold rounded-lg text-blue-600 bg-blue-100 hover:bg-blue-200 transition-colors duration-200">
                                <i class="bi bi-eye-fill mr-1"></i><span class="text-xs">View Product</span>
                            </a>
                        </td>
                    </tr>
                    </tbody>
                    <tfoot class="bg-gray-50/80">
                    <tr>
                        <th colspan="5" class="px-4 py-3 text-right text-sm font-bold text-gray-900">Totals:</th>
                        <th class="px-4 py-3 text-sm font-bold text-gray-900" th:text="'₹' + ${#numbers.formatDecimal(totalCostPrice, 0, 2)}">₹0.00</th>
                        <th class="px-4 py-3 text-sm font-bold text-gray-900" th:text="'₹' + ${#numbers.formatDecimal(order.totalPrice, 0, 2)}">₹0.00</th>
                        <th class="px-4 py-3 text-sm font-bold"
                            th:classappend="${totalProfitLoss >= 0 ? 'text-green-600' : 'text-red-600'}"
                            th:text="${totalProfitLoss >= 0 ? '+' : ''} + '₹' + ${#numbers.formatDecimal(totalProfitLoss, 0, 2)}">₹0.00</th>
                        <th class="px-4 py-3 text-sm font-bold"
                            th:classappend="${profitMargin >= 0 ? 'text-green-600' : 'text-red-600'}"
                            th:text="${#numbers.formatDecimal(profitMargin, 0, 2)} + '%'">0.0%</th>
                        <th class="px-4 py-3"></th>
                    </tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </div>

    <!-- Analytics & Actions -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">

        <!-- Performance Insights -->
        <div class="glass-card rounded-2xl shadow-2xl p-5 animate-fade-in" style="animation-delay: 0.9s;">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="bi bi-lightbulb text-yellow-500 mr-2"></i>Performance Insights
            </h3>
            <div class="space-y-3">
                <div class="p-3 rounded-lg" th:classappend="${profitMargin >= 20 ? 'bg-green-50 border border-green-200' : (profitMargin >= 10 ? 'bg-yellow-50 border border-yellow-200' : 'bg-red-50 border border-red-200')}">
                    <div class="flex items-center">
                        <i th:class="${profitMargin >= 20 ? 'bi bi-check-circle-fill text-green-500' : (profitMargin >= 10 ? 'bi bi-exclamation-circle-fill text-yellow-500' : 'bi bi-x-circle-fill text-red-500')} + ' mr-3'"></i>
                        <div>
                            <h4 class="font-semibold text-gray-900 text-sm">Profitability Status</h4>
                            <p class="text-xs text-gray-600" th:text="${profitMargin >= 20 ? 'Excellent profit margin. Great business performance!' : (profitMargin >= 10 ? 'Good profit margin. Room for improvement.' : 'Low profit margin. Consider reviewing pricing strategy.')}">Status message</p>
                        </div>
                    </div>
                </div>

                <div class="flex justify-between items-center p-2 bg-blue-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Best Performing Item</span>
                    <span class="text-xs font-bold text-blue-600" th:text="${bestPerformingItem ?: 'N/A'}">Product Name</span>
                </div>

                <div class="flex justify-between items-center p-2 bg-orange-50 rounded-lg" th:if="${worstPerformingItem}">
                    <span class="text-xs font-medium text-gray-700">Needs Attention</span>
                    <span class="text-xs font-bold text-orange-600" th:text="${worstPerformingItem}">Product Name</span>
                </div>

                <div class="flex justify-between items-center p-2 bg-purple-50 rounded-lg">
                    <span class="text-xs font-medium text-gray-700">Avg Profit Per Item</span>
                    <span class="text-xs font-bold text-purple-600" th:text="'₹' + ${#numbers.formatDecimal(avgItemProfit ?: 0, 0, 2)}">₹0.00</span>
                </div>

                <!-- Additional Performance Metrics -->
                <div class="mt-4">
                    <h4 class="font-semibold text-gray-900 mb-3 text-sm">Order Performance</h4>
                    <div class="relative">
                        <div class="absolute left-4 top-0 bottom-0 w-0.5 bg-gray-200"></div>

                        <!-- Created -->
                        <div class="relative flex items-center pb-3">
                            <div class="flex-shrink-0 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center">
                                <i class="bi bi-check text-white text-sm"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-900">Order Created</p>
                                <p class="text-xs text-gray-500" th:text="${order.createdAt != null ? #temporals.format(order.createdAt, 'MMM dd, yyyy HH:mm') : 'N/A'}">Date</p>
                            </div>
                        </div>

                        <!-- Processing -->
                        <div class="relative flex items-center pb-3">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center"
                                 th:classappend="${order.orderStatus.name() == 'PROCESSING' || order.orderStatus.name() == 'COMPLETED' ? 'bg-blue-500' : 'bg-gray-300'}">
                                <i class="bi bi-clock text-white text-sm" th:if="${order.orderStatus.name() == 'PROCESSING' || order.orderStatus.name() == 'COMPLETED'}"></i>
                                <i class="bi bi-circle text-white text-sm" th:unless="${order.orderStatus.name() == 'PROCESSING' || order.orderStatus.name() == 'COMPLETED'}"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-900">Processing</p>
                                <p class="text-xs text-gray-500">Order fulfillment</p>
                            </div>
                        </div>

                        <!-- Completed -->
                        <div class="relative flex items-center">
                            <div class="flex-shrink-0 w-8 h-8 rounded-full flex items-center justify-center"
                                 th:classappend="${order.orderStatus.name() == 'COMPLETED' ? 'bg-green-500' : 'bg-gray-300'}">
                                <i class="bi bi-check text-white text-sm" th:if="${order.orderStatus.name() == 'COMPLETED'}"></i>
                                <i class="bi bi-circle text-white text-sm" th:unless="${order.orderStatus.name() == 'COMPLETED'}"></i>
                            </div>
                            <div class="ml-4">
                                <p class="text-sm font-medium text-gray-900">Completed</p>
                                <p class="text-xs text-gray-500">Order delivered</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Quick Actions -->
        <div class="glass-card rounded-2xl shadow-2xl p-5 animate-fade-in" style="animation-delay: 1.0s;">
            <h3 class="text-lg font-bold text-gray-900 mb-4">
                <i class="bi bi-lightning-charge-fill text-yellow-500 mr-2"></i>Quick Actions
            </h3>
            <div class="space-y-2">
                <form th:action="@{/invoices/download(orderIds=${order.orderId})}" method="get">
                    <input type="hidden" name="orderIds" th:value="${order.orderId}">
                    <button type="submit" class="w-full bg-gradient-to-r from-purple-500 to-purple-600 text-white py-2 px-3 rounded-xl hover:shadow-lg transition-all duration-300 font-semibold text-center text-sm">
                        <i class="bi bi-file-earmark-pdf-fill mr-2"></i>Generate Invoice
                    </button>
                </form>

                <a th:href="@{/orders/{id}/edit(id=${order.orderId})}"
                   th:if="${order.orderStatus.name() == 'CREATED'}"
                   class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-3 rounded-xl hover:shadow-lg transition-all duration-300 font-semibold text-center block text-sm">
                    <i class="bi bi-pencil-fill mr-2"></i>Edit Order
                </a>

                <button th:if="${order.orderStatus.name() == 'CREATED'}"
                        onclick="updateOrderStatus('PROCESSING')"
                        class="w-full bg-gradient-to-r from-green-500 to-green-600 text-white py-2 px-3 rounded-xl hover:shadow-lg transition-all duration-300 font-semibold text-sm">
                    <i class="bi bi-arrow-right-circle-fill mr-2"></i>Process Order
                </button>

                <button th:if="${order.orderStatus.name() == 'PROCESSING'}"
                        onclick="updateOrderStatus('COMPLETED')"
                        class="w-full bg-gradient-to-r from-blue-500 to-blue-600 text-white py-2 px-3 rounded-xl hover:shadow-lg transition-all duration-300 font-semibold text-sm">
                    <i class="bi bi-check-circle-fill mr-2"></i>Complete Order
                </button>

                <button th:if="${order.orderStatus.name() != 'CANCELLED' && order.orderStatus.name() != 'COMPLETED'}"
                        onclick="cancelOrder()"
                        class="w-full bg-gradient-to-r from-red-500 to-red-600 text-white py-2 px-3 rounded-xl hover:shadow-lg transition-all duration-300 font-semibold text-sm">
                    <i class="bi bi-x-circle-fill mr-2"></i>Cancel Order
                </button>

                <a th:if="${order.customer != null}"
                   th:href="@{/customers/{id}(id=${order.customer.customerId})}"
                   class="w-full bg-gradient-to-r from-gray-500 to-gray-600 text-white py-2 px-3 rounded-xl hover:shadow-lg transition-all duration-300 font-semibold text-center block text-sm">
                    <i class="bi bi-person mr-2"></i>View Customer Details
                </a>

                <!-- Additional Actions -->
                <div class="border-t border-gray-200 pt-3 mt-3">
                    <h4 class="text-sm font-semibold text-gray-700 mb-2">Additional Actions</h4>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="exportToPDF()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-2 rounded-lg text-xs font-medium transition-colors">
                            <i class="bi bi-file-pdf mr-1"></i>Export PDF
                        </button>
                        <button onclick="sendEmail()" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-2 rounded-lg text-xs font-medium transition-colors">
                            <i class="bi bi-envelope mr-1"></i>Email Invoice
                        </button>
                        <a th:href="@{/orders}" class="bg-gray-100 hover:bg-gray-200 text-gray-700 py-2 px-2 rounded-lg text-xs font-medium transition-colors text-center">
                            <i class="bi bi-list mr-1"></i>All Orders
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="scripts">
    <script>

<!--    Enhanced search functionality for items (works for both views)-->
        document.addEventListener('DOMContentLoaded', function() {
        const searchInput = document.getElementById('itemSearch');
        const searchFeedback = document.getElementById('searchFeedback');
        const cardViewBtn = document.getElementById('cardViewBtn');
        const tableViewBtn = document.getElementById('tableViewBtn');
        const cardView = document.getElementById('cardView');
        const tableView = document.getElementById('tableView');

        let currentView = 'card'; // Default view

        // View toggle functionality
        function switchToCardView() {
        console.log('Switching to card view');
        currentView = 'card';
        if (cardView && tableView) {
        cardView.classList.remove('hidden');
        tableView.classList.add('hidden');
        }
        if (cardViewBtn && tableViewBtn) {
        cardViewBtn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
        cardViewBtn.classList.remove('text-gray-600');
        tableViewBtn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
        tableViewBtn.classList.add('text-gray-600');
        }
        }

        function switchToTableView() {
        console.log('Switching to table view');
        currentView = 'table';
        if (cardView && tableView) {
        tableView.classList.remove('hidden');
        cardView.classList.add('hidden');
        }
        if (cardViewBtn && tableViewBtn) {
        tableViewBtn.classList.add('bg-white', 'text-gray-900', 'shadow-sm');
        tableViewBtn.classList.remove('text-gray-600');
        cardViewBtn.classList.remove('bg-white', 'text-gray-900', 'shadow-sm');
        cardViewBtn.classList.add('text-gray-600');
        }
        }

        // Event listeners for view toggle buttons
        if (cardViewBtn) {
        cardViewBtn.addEventListener('click', function(e) {
        e.preventDefault();
        switchToCardView();
        });
        }

        if (tableViewBtn) {
        tableViewBtn.addEventListener('click', function(e) {
        e.preventDefault();
        switchToTableView();
        });
        }

        // Search functionality
        if (searchInput) {
        searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        let items, visibleCount = 0;

        if (currentView === 'card') {
        items = document.querySelectorAll('.item-card');
        } else {
        items = document.querySelectorAll('.item-row');
        }

        items.forEach(function(item) {
        const text = item.textContent.toLowerCase();
        const isVisible = text.includes(searchTerm);
        item.style.display = isVisible ? '' : 'none';
        if (isVisible) visibleCount++;
        });

        // Update search feedback
        if (searchTerm) {
        searchFeedback.textContent = `${visibleCount} items found`;
        searchFeedback.className = 'text-xs text-blue-600 font-medium';
        } else {
        searchFeedback.textContent = '';
        }
        });
        }

        // Debug: Log elements found
        console.log('Card view element:', cardView);
        console.log('Table view element:', tableView);
        console.log('Card button:', cardViewBtn);
        console.log('Table button:', tableViewBtn);
        });
        // Auto-hide flash messages
        setTimeout(function() {
            const alerts = document.querySelectorAll('.success-alert, .error-alert');
            alerts.forEach(function(alert) {
                alert.style.transition = 'opacity 0.5s ease-out';
                alert.style.opacity = '0';
                setTimeout(() => alert.remove(), 500);
            });
        }, 5000);

        // Enhanced search functionality for items
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('itemSearch');
            const searchFeedback = document.getElementById('searchFeedback');

            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    const searchTerm = this.value.toLowerCase();
                    const cards = document.querySelectorAll('.item-card');
                    let visibleCount = 0;

                    cards.forEach(function(card) {
                        const text = card.textContent.toLowerCase();
                        const isVisible = text.includes(searchTerm);
                        card.style.display = isVisible ? '' : 'none';
                        if (isVisible) visibleCount++;
                    });

                    // Update search feedback
                    if (searchTerm) {
                        searchFeedback.textContent = `${visibleCount} items found`;
                        searchFeedback.className = 'text-xs text-blue-600 font-medium';
                    } else {
                        searchFeedback.textContent = '';
                    }
                });
            }
        });

        // Order status update functions
        function updateOrderStatus(newStatus) {
            const orderId = '[[${order.orderId}]]';
            let confirmMessage = '';

            switch(newStatus) {
                case 'PROCESSING':
                    confirmMessage = 'Are you sure you want to process this order?';
                    break;
                case 'COMPLETED':
                    confirmMessage = 'Are you sure you want to mark this order as completed?';
                    break;
                default:
                    confirmMessage = `Are you sure you want to update this order status to ${newStatus}?`;
            }

            if (confirm(confirmMessage)) {
                fetch(`/orders/${orderId}/status`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `status=${newStatus}`
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to update order status');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error updating order status');
                });
            }
        }

        function cancelOrder() {
            const orderId = '[[${order.orderId}]]';
            const reason = prompt('Please enter cancellation reason (optional):');

            if (reason !== null) { // User didn't click cancel
                fetch(`/orders/${orderId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `reason=${encodeURIComponent(reason || '')}`
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Failed to cancel order');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error cancelling order');
                });
            }
        }

        // Additional action functions
        function exportToPDF() {
            window.print();
        }

        function sendEmail() {
            const orderId = '[[${order.orderId}]]';
            const customerEmail = '[[${order.customer?.email}]]';

            if (customerEmail && customerEmail !== '') {
                const subject = `Invoice for Order #${orderId}`;
                const body = `Dear Customer,\n\nPlease find your invoice for Order #${orderId}.\n\nBest regards,\nYour Company`;
                window.location.href = `mailto:${customerEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            } else {
                alert('Customer email not available');
            }
        }

        // Animate cards on scroll
        const observerOptions = {
            threshold: 0.1,
            rootMargin: '0px 0px -50px 0px'
        };

        const observer = new IntersectionObserver(function(entries) {
            entries.forEach(entry => {
                if (entry.isIntersecting) {
                    entry.target.classList.add('animate-fade-in');
                }
            });
        }, observerOptions);

        // Observe all metric cards
        document.querySelectorAll('.metric-card').forEach(card => {
            observer.observe(card);
        });
    </script>
</th:block>
</body>
</html>