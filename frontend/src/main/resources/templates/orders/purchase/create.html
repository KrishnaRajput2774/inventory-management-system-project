    <!DOCTYPE html>
    <html xmlns:th="http://www.thymeleaf.org"
          xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
          layout:decorate="~{_layout}">

    <head>
        <title>Create Purchase Order - Product Management System</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
        <style>
            .metric-card {
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                transition: all 0.3s ease;
                cursor: pointer;
            }
            .metric-card:hover {
                transform: translateY(-2px);
                box-shadow: 0 15px 35px rgba(102, 126, 234, 0.15);
            }
            .purchase-card {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            }
            .items-card {
                background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            }
            .total-card {
                background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%);
            }
            .progress-card {
                background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
            }
            .glass-card {
                background: rgba(255, 255, 255, 0.9);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(255, 255, 255, 0.2);
                position: relative;
                overflow: visible;
            }
            .success-alert {
                background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
                color: white;
                border: none;
            }
            .error-alert {
                background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
                color: white;
                border: none;
            }
            .warning-alert {
                background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
                color: white;
                border: none;
            }
            .animate-fade-in {
                animation: fadeIn 0.6s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; transform: translateY(20px); }
                to { opacity: 1; transform: translateY(0); }
            }
            .pulse {
                animation: pulse 2s infinite;
            }
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.05); }
            }

            /* Fixed Dropdown Styles with higher z-index */
            .search-dropdown {
                position: absolute;
                z-index: 10500;
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border: 1px solid rgba(229, 231, 235, 0.8);
                border-radius: 12px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                max-height: 300px;
                overflow-y: auto;
                width: 100%;
                margin-top: 4px;
<!--                animation: fadeIn 0.2s ease-out;-->
            }

            .search-dropdown-item {
                z-index: 10000;
                font-size: 8px;
                padding: 4px 6px;
                cursor: pointer;
                border-bottom: 1px solid rgba(243, 244, 246, 0.8);
                transition: all 0.2s ease;
                background: transparent;
            }

            .search-dropdown-item:hover,
            .search-dropdown-item.highlighted {
                background: linear-gradient(135deg, #eff6ff 0%, #f0f9ff 100%);
<!--                transform: translateX(4px);-->
            }

            .search-container {
                position: relative;
                z-index: 1;
            }

            /* Order Item Rows */
            .order-item-row {
                background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(249, 250, 251, 0.9) 100%);
                border-radius: 16px;
                padding: 24px;
                border: 1px solid rgba(229, 231, 235, 0.5);
<!--                transition: all 0.3s ease;-->
                position: relative;
                overflow: visible;
                margin-bottom: 24px;
<!--                animation: fadeIn 0.3s ease-out;-->
            }

            .order-item-row::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                height: 3px;
                background: linear-gradient(90deg, #3b82f6, #06b6d4);
                opacity: 0;
<!--                transition: opacity 0.3s ease;-->
                border-radius: 16px 16px 0 0;
            }

            .order-item-row:hover::before {
                opacity: 1;
            }

            .order-item-row:hover {
<!--                transform: translateY(-2px) scale(1.01);-->
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
                border-color: #3b82f6;
            }

            /* Product Details Section */
            .product-details-section {
                background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
                border: 1px solid #bfdbfe;
                border-radius: 12px;
                padding: 16px;
                margin-top: 16px;
                display: none;
            }

            .product-details-section.show {
                display: block;
                animation: fadeIn 0.3s ease-out;
            }

            /* Input Styles */
            .input-field {
                border: 1px solid #e5e7eb;
                border-radius: 12px;
                padding: 8px 12px;
                transition: all 0.3s ease;
                background: white;
                color: #111827;
                font-size: 12px;
                font-weight: 500;
            }

            .input-field::placeholder {
                font-size: 12px;
            }

            .input-field:focus {
                border-color: #3b82f6;
                outline: none;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
                background: white;
                transform: scale(1.01);
            }

            /* Button Styles */
            .btn-primary {
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 6px 12px;
                font-weight: 600;
                transition: all 0.3s ease;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                box-shadow: 0 4px 14px 0 rgba(59, 130, 246, 0.4);
                text-decoration: none;
            }

            .btn-primary:hover {
                background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
                transform: translateY(-2px) scale(1.02);
                box-shadow: 0 8px 25px 0 rgba(59, 130, 246, 0.6);
            }

            .btn-secondary {
                background: linear-gradient(135deg, #f3f4f6 0%, #e5e7eb 100%);
                border: 1px solid #d1d5db;
                color: #374151;
                border-radius: 12px;
                padding: 6px 12px;
                font-weight: 600;
                transition: all 0.3s ease;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                text-decoration: none;
            }

            .btn-secondary:hover {
                background: linear-gradient(135deg, #e5e7eb 0%, #d1d5db 100%);
                color: #111827;
                transform: translateY(-2px) scale(1.02);
                box-shadow: 0 4px 14px 0 rgba(0, 0, 0, 0.1);
            }

            .btn-danger {
                background: linear-gradient(135deg, #dc2626 0%, #b91c1c 100%);
                color: white;
                border: none;
                border-radius: 12px;
                padding: 5px 10px;
                font-weight: 600;
                transition: all 0.3s ease;
                cursor: pointer;
                display: inline-flex;
                align-items: center;
                justify-content: center;
                font-size: 10px;
                box-shadow: 0 4px 14px 0 rgba(220, 38, 38, 0.4);
            }

            .btn-danger:hover {
                background: linear-gradient(135deg, #b91c1c 0%, #991b1b 100%);
                transform: translateY(-2px) scale(1.02);
                box-shadow: 0 8px 25px 0 rgba(220, 38, 38, 0.6);
            }

            /* Modal Styles */
            .modal {
                display: none;
                position: fixed;
                z-index: 10001;
                left: 0;
                top: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(4px);
                animation: fadeIn 0.3s ease-out;
            }

            .modal-content {
                background: rgba(255, 255, 255, 0.98);
                backdrop-filter: blur(20px);
                border-radius: 16px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                border: 1px solid rgba(229, 231, 235, 0.5);
                margin: 5% auto;
                max-width: 600px;
                width: 90%;
            }

            /* Selected Entity Info */
            .selected-entity-info {
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
                border: 1px solid #93c5fd;
                border-radius: 12px;
                padding: 16px;
                margin-top: 8px;
                position: relative;
                animation: fadeIn 0.3s ease-out;
            }

            /* Total Display - Fixed z-index issue */
            .total-display {
                background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
                border: 2px solid #3b82f6;
                border-radius: 16px;
                padding: 20px;
                text-align: center;
                position: relative;
                overflow: hidden;
                z-index: 1;
            }

            .total-amount {
                font-size: 28px;
                font-weight: 800;
                color: #2563eb;
                position: relative;
                z-index: 1;
            }

            /* Item Total Display */
            .item-total-display {
                background: linear-gradient(135deg, #eff6ff 0%, #e5f3ff 100%);
                border: 1px solid #93c5fd;
                border-radius: 12px;
                padding: 8px 8px;
                font-weight: 700;
                text-align: center;
                color: #1d4ed8;
                font-size: 12px;
            }

            /* Create New Button */
            .create-new-btn {
                position: absolute;
                right: 8px;
                top: 50%;
                transform: translateY(-50%);
                background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
                color: white;
                border: none;
                border-radius: 8px;
                padding: 4px 8px;
                font-size: 10px;
                font-weight: 600;
                cursor: pointer;
                transition: all 0.3s ease;
                z-index: 5;
            }

            .create-new-btn:hover {
                background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
                transform: translateY(-50%) scale(1.05);
            }

            /* Form Grid */
            .form-grid {
                display: grid;
                gap: 24px;
            }

            .form-grid-2 {
                grid-template-columns: 1fr 1fr;
            }

            .form-grid-3 {
                grid-template-columns: 1fr 1fr 1fr;
            }

            .form-grid-4 {
                grid-template-columns: 1fr 1fr 1fr 1fr;
            }

            @media (max-width: 768px) {
                .form-grid-2, .form-grid-3, .form-grid-4 {
                    grid-template-columns: 1fr;
                }
            }

            /* Form Label */
            .form-label {
                display: block;
                font-size: 10px;
                font-weight: 700;
                color: #374151;
                margin-bottom: 8px;
                text-transform: uppercase;
                letter-spacing: 0.5px;
            }

            /* Select Styles */
            select.input-field {
                appearance: none;
                background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
                background-position: right 12px center;
                background-repeat: no-repeat;
                background-size: 16px;
                padding-right: 40px;
                font-size: 10px;
            }

            /* Product Info */
            .product-info-badge {
                display: inline-block;
                background: linear-gradient(135deg, #e5e7eb 0%, #f3f4f6 100%);
                color: #4b5563;
                padding: 1px 2px;
                border-radius: 6px;
                font-size: 7px;
                margin-left: 4px;
                font-weight: 500;
            }

            .stock-indicator {
                font-size: 5px;
                padding: 1.5px 2px;
                border-radius: 6px;
                font-weight: 500;
            }

            .stock-high {
                background: linear-gradient(135deg, #dcfce7 0%, #d1fae5 100%);
                color: #15803d;
            }

            .stock-medium {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                color: #a16207;
            }

            .stock-low {
                background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%);
                color: #dc2626;
            }

            /* New Product Indicator */
            .new-product-indicator {
                background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
                color: #a16207;
                padding: 4px 6px;
                border-radius: 8px;
                margin-bottom: 16px;
                font-size: 12px;
                font-weight: 600;
                display: none;
            }

            .new-product-indicator.show {
                display: block;
                animation: fadeIn 0.3s ease-out;
            }

            /* Notification */
            .notification {
                position: fixed;
                top: 24px;
                right: 24px;
                z-index: 10002;
                padding: 16px 20px;
                border-radius: 12px;
                box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
                font-size: 12px;
                max-width: 400px;
                backdrop-filter: blur(8px);
                animation: fadeIn 0.3s ease-out;
                font-weight: 600;
            }

            /* Priority field indicator */
            .priority-field {
                position: relative;
            }

            .priority-field::after {
                content: '★';
                position: absolute;
                right: -20px;
                top: 50%;
                transform: translateY(-50%);
                color: #fbbf24;
                font-size: 16px;
            }
        </style>
    </head>

    <body class="bg-gradient-to-br from-blue-50 to-sky-100 min-h-screen">
    <div layout:fragment="content">

        <!-- Flash Messages -->
        <div th:if="${successMessage}" class="success-alert rounded-xl p-4 mb-6 shadow-lg animate-fade-in">
            <div class="flex items-center">
                <i class="bi bi-check-circle-fill mr-3 text-xl"></i>
                <span th:text="${successMessage}"></span>
            </div>
        </div>
        <div th:if="${errorMessage}" class="error-alert rounded-xl p-4 mb-6 shadow-lg animate-fade-in">
            <div class="flex items-center">
                <i class="bi bi-exclamation-triangle-fill mr-3 text-xl"></i>
                <span th:text="${errorMessage}"></span>
            </div>
        </div>

        <!-- Header Section -->
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-start gap-6 mb-4">
            <div class="animate-fade-in">
                <h1 class="text-xl font-bold text-gray-900 mb-3">Create Purchase Order</h1>
<!--                <p class="text-lg text-gray-600">Create a new purchase order from your suppliers to restock inventory</p>-->
            </div>
            <div class="flex flex-wrap gap-2 animate-fade-in">
                <a href="/orders" class="btn-primary">
                    <i class="bi bi-list mr-1.5"></i>View All Orders
                </a>
                <a href="/orders/sales/create" class="btn-secondary">
                    <i class="bi bi-cart-plus mr-1.5"></i>Create Sales Order
                </a>
                <a href="/dashboard" class="btn-secondary">
                    <i class="bi bi-arrow-left mr-1.5"></i>Back to Dashboard
                </a>
            </div>
        </div>

        <!-- Purchase Order Dashboard -->
<!--        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">-->
<!--            &lt;!&ndash; Order Type &ndash;&gt;-->
<!--            <div class="metric-card purchase-card rounded-2xl text-white p-6 shadow-2xl animate-fade-in">-->
<!--                <div class="flex items-center justify-between">-->
<!--                    <div>-->
<!--                        <p class="text-white/80 text-sm font-medium uppercase tracking-wide">Order Type</p>-->
<!--                        <p class="text-2xl font-bold mt-2">Purchase Order</p>-->
<!--                        <div class="flex items-center mt-3">-->
<!--                            <i class="bi bi-truck text-white/60 mr-2"></i>-->
<!--                            <span class="text-white/80 text-sm">Supplier Purchase</span>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">-->
<!--                        <i class="bi bi-box-arrow-in-down text-3xl"></i>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->

<!--            &lt;!&ndash; Items Count &ndash;&gt;-->
<!--            <div class="metric-card items-card rounded-2xl text-white p-6 shadow-2xl animate-fade-in" style="animation-delay: 0.1s;">-->
<!--                <div class="flex items-center justify-between">-->
<!--                    <div>-->
<!--                        <p class="text-white/80 text-sm font-medium uppercase tracking-wide">Items Added</p>-->
<!--                        <p class="text-4xl font-bold mt-2" id="itemsCount">0</p>-->
<!--                        <div class="flex items-center mt-3">-->
<!--                            <i class="bi bi-box text-white/60 mr-2"></i>-->
<!--                            <span class="text-white/80 text-sm">Products</span>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">-->
<!--                        <i class="bi bi-boxes text-3xl"></i>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->

<!--            &lt;!&ndash; Order Total &ndash;&gt;-->
<!--            <div class="metric-card total-card rounded-2xl text-white p-6 shadow-2xl animate-fade-in" style="animation-delay: 0.2s;">-->
<!--                <div class="flex items-center justify-between">-->
<!--                    <div>-->
<!--                        <p class="text-white/80 text-sm font-medium uppercase tracking-wide">Order Total</p>-->
<!--                        <p class="text-4xl font-bold mt-2" id="totalDisplay">₹0.00</p>-->
<!--                        <div class="flex items-center mt-3">-->
<!--                            <i class="bi bi-currency-rupee text-white/60 mr-2"></i>-->
<!--                            <span class="text-white/80 text-sm">Amount</span>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">-->
<!--                        <i class="bi bi-calculator text-3xl"></i>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->

<!--            &lt;!&ndash; Progress &ndash;&gt;-->
<!--            <div class="metric-card progress-card rounded-2xl text-white p-6 shadow-2xl animate-fade-in" style="animation-delay: 0.3s;">-->
<!--                <div class="flex items-center justify-between">-->
<!--                    <div>-->
<!--                        <p class="text-white/80 text-sm font-medium uppercase tracking-wide">Progress</p>-->
<!--                        <p class="text-2xl font-bold mt-2" id="progressDisplay">Select Supplier</p>-->
<!--                        <div class="flex items-center mt-3">-->
<!--                            <i class="bi bi-speedometer text-white/60 mr-2"></i>-->
<!--                            <span class="text-white/80 text-sm">Status</span>-->
<!--                        </div>-->
<!--                    </div>-->
<!--                    <div class="w-16 h-16 bg-white/20 rounded-2xl flex items-center justify-center">-->
<!--                        <i class="bi bi-graph-up text-3xl"></i>-->
<!--                    </div>-->
<!--                </div>-->
<!--            </div>-->
<!--        </div>-->

        <!-- Main Form -->
        <div class="glass-card rounded-2xl shadow-2xl animate-fade-in" style="animation-delay: 0.4s;">

<!--             Form Header-->
            <div class="px-3 py-2 border-b border-gray-200/50 bg-gradient-to-r from-blue-50 to-sky-50 rounded-t-2xl">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900">Purchase Order Configuration</h3>
                        <p class="text-xs text-gray-600 mt-1">Configure purchase order details and add products from suppliers</p>
                    </div>
                </div>
            </div>

            <!-- Form Body -->
            <div class="p-4">
                <form th:action="@{/orders/purchase/create}" th:object="${order}" method="post" id="purchaseOrderForm" class="space-y-2">

                    <!-- Hidden Order Type Field -->
                    <input type="hidden" th:field="*{orderType}" value="PURCHASE">

                    <!-- Supplier and Basic Info -->
                    <div class="form-grid form-grid-2">
                        <!-- Supplier Field -->
                        <div>
                            <label for="supplierSearch" class="form-label">
                                Supplier <span class="text-red-600">*</span>
                            </label>
                            <div class="search-container">
                                <input type="text" id="supplierSearch" class="input-field w-full" style="padding-right: 100px;"
                                       placeholder="Search suppliers by name, email..." autocomplete="off">
                                <button type="button" class="create-new-btn" id="createSupplierBtn">+ Add New</button>
                                <div id="supplierDropdown" class="search-dropdown z-10" style="display: none;"></div>
                                <input type="hidden" name="supplier.id" id="selectedSupplierId" required>
                            </div>
                            <div id="selectedSupplierInfo" class="selected-entity-info" style="display: none;">
                                <div class="text-[100px] text-gray-700 font-semibold">
                                    <i class="bi bi-building mr-2"></i>
                                    <span id="selectedSupplierName"></span>
                                </div>
                            </div>
                        </div>

                        <!-- Payment Type -->
                        <div>
                            <label for="paymentType" class="form-label">
                                Payment Method <span class="text-red-600">*</span>
                            </label>
                            <select class="input-field w-full" id="paymentType" th:field="*{paymentType}" required>
                                <option value="">Select payment method</option>
                                <option value="CASH">Cash Payment</option>
                                <option value="CARD">Card Payment</option>
                                <option value="UPI">UPI Payment</option>
                            </select>
                        </div>

                        <!-- Order Status -->
                        <div style="grid-column: span 2;">
                            <label for="orderStatus" class="form-label">Order Status</label>
                            <select class="input-field w-full" id="orderStatus" th:field="*{orderStatus}">
                                <option value="CREATED" selected>Draft</option>
                                <option value="PROCESSING">In Progress</option>
                                <option value="COMPLETED">Completed</option>
                            </select>
                            <div class="mt-2 warning-alert rounded-lg p-2">
                                <div class="text-xs font-semibold">
                                    <i class="bi bi-info-circle mr-2"></i>
                                    Stock will be automatically increased when order is completed
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Order Items Section -->
                    <div class="border-t border-gray-200/50 pt-4">
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h3 class="text-lg font-bold text-gray-900">Product Items <span class="text-red-600">*</span></h3>
                                <p class="text-gray-600 text-xs mt-1">Add products with purchase pricing. New products can be created inline.</p>
                            </div>
                            <button type="button" class="btn-primary pulse" id="addItemBtn">
                                <i class="bi bi-plus mr-2"></i>Add Product
                            </button>
                        </div>

                        <div id="orderItems">
                            <!-- Default item row will be added dynamically -->
                        </div>

                        <!-- Total Display -->
                        <div class="total-display mt-6">
                            <div class="text-gray-700 font-bold mb-3 text-base">Purchase Order Total</div>
                            <div class="total-amount">₹ <span id="totalPrice">0.00</span></div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="flex justify-end gap-4 border-t border-gray-200/50 pt-8">
                        <a href="/orders" class="btn-secondary">Cancel Order</a>
                        <button type="submit" class="btn-primary">
                            <i class="bi bi-check mr-2"></i>Create Purchase Order
                        </button>
                    </div>
                </form>
            </div>
        </div>

        <!-- Supplier Modal -->
        <div id="supplierModal" class="modal">
            <div class="modal-content">
                <div class="px-6 py-4 border-t border-gray-200/50 bg-gradient-to-r from-blue-50 to-sky-50 rounded-b-2xl">
                    <div class="flex justify-end gap-3">
                        <button type="button" class="btn-secondary close-modal">Cancel</button>
                        <button type="button" id="saveSupplier" class="btn-primary">Create Supplier</button>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <th:block layout:fragment="scripts">
        <script th:inline="javascript">
            let suppliers = /*[[${suppliers}]]*/ [];
            let products = /*[[${products}]]*/ [];
            let categories = /*[[${categories}]]*/ [];
            let itemIndex = 0;

            $(document).ready(function() {
                initializeSearchFunctionality();
                initializeModalFunctionality();
                initializeOrderItems();
                updateDashboard();

                // Add first item row on page load
                addOrderItem();

                $('#paymentType, #orderStatus').on('change', function() {
                    updateDashboard();
                    saveFormState();
                });

                $('input, select, textarea').on('change input', function() {
                    updateDashboard();
                    saveFormState();
                });
            });

            function updateDashboard() {
                const itemsCount = $('.product-id-input').filter(function() {
                    return $(this).val();
                }).length;
                $('#itemsCount').text(itemsCount);

                const total = parseFloat($('#totalPrice').text()) || 0;
                $('#totalDisplay').text('₹' + total.toFixed(2));

                let progress = 'Select Supplier';
                if ($('#selectedSupplierId').val()) {
                    if (itemsCount > 0) {
                        if ($('#paymentType').val()) {
                            progress = 'Ready to Submit';
                        } else {
                            progress = 'Choose Payment';
                        }
                    } else {
                        progress = 'Add Products';
                    }
                }
                $('#progressDisplay').text(progress);
            }

            function initializeSearchFunctionality() {
                // Supplier search
                $('#supplierSearch').on('focus', function() {
                    if (suppliers.length > 0) {
                        showSupplierDropdown(suppliers);
                    }
                }).on('input', function() {
                    const query = $(this).val().toLowerCase().trim();
                    if (query.length >= 1) {
                        const filtered = suppliers.filter(supplier => {
                            return (supplier.name && supplier.name.toLowerCase().includes(query)) ||
                                   (supplier.email && supplier.email.toLowerCase().includes(query)) ||
                                   (supplier.contactNumber && supplier.contactNumber.toString().includes(query));
                        });
                        showSupplierDropdown(filtered);
                    } else {
                        showSupplierDropdown(suppliers);
                    }
                });

                // Product search delegation
                $(document).on('focus', '.product-search', function() {
                    const dropdown = $(this).siblings('.product-dropdown');
                    if (products.length > 0) {
                        showProductDropdown(products, dropdown);
                    }
                }).on('input', '.product-search', function() {
                    const query = $(this).val().toLowerCase().trim();
                    const dropdown = $(this).siblings('.product-dropdown');
                    const row = $(this).closest('.order-item-row');

                    if (query.length >= 1) {
                        const filtered = products.filter(product =>
                            (product.name && product.name.toLowerCase().includes(query)) ||
                            (product.brandName && product.brandName.toLowerCase().includes(query)) ||
                            (product.productCode && product.productCode.toLowerCase().includes(query)) ||
                            (product.category && product.category.name && product.category.name.toLowerCase().includes(query))
                        );

                        // Check if the query doesn't match any existing product
                        if (filtered.length === 0) {
                            row.find('.new-product-indicator').addClass('show');
                            row.find('.product-details-section').addClass('show');
                            // Set the product name field with the search query
                            row.find('.product-name-input').val(query);
                        } else {
                            row.find('.new-product-indicator').removeClass('show');
                        }

                        showProductDropdown(filtered, dropdown);
                    } else {
                        showProductDropdown(products, dropdown);
                        row.find('.new-product-indicator').removeClass('show');
                    }
                });

                $(document).on('click', function(e) {
                    if (!$(e.target).closest('.search-container').length) {
                        $('.search-dropdown').hide();
                    }
                });
            }

            function showSupplierDropdown(filteredSuppliers) {
                const dropdown = $('#supplierDropdown');
                dropdown.empty();

                if (filteredSuppliers.length === 0) {
                    dropdown.html('<div class="search-dropdown-item text-gray-600">No suppliers found</div>');
                } else {
                    filteredSuppliers.forEach(supplier => {
                        const supplierHtml = `
                            <div class="search-dropdown-item" data-id="${supplier.id}" data-type="supplier">
                                <div class="font-semibold text-gray-900 text-[10px]">${supplier.name || 'No Name'}</div>
                                <div class="text-[10px] text-gray-600">${supplier.email || 'No Email'} • ${supplier.contactNumber || 'No Contact'}</div>
                            </div>
                        `;
                        dropdown.append(supplierHtml);
                    });
                }
                dropdown.show();
            }

            function showProductDropdown(filteredProducts, dropdown) {
                dropdown.empty();

                if (filteredProducts.length === 0) {
                    dropdown.html(`
                        <div class="search-dropdown-item text-gray-600">
                            <div class="font-semibold">No products found</div>
                            <div class="text-[10px] mt-1">This will be created as a new product</div>
                        </div>
                    `);
                } else {
                    filteredProducts.forEach(product => {
                        const totalStock = product.totalStock || product.stockQuantity || 0;
                        const stockClass = totalStock > 50 ? 'stock-high' :
                                         totalStock > 10 ? 'stock-medium' : 'stock-low';
                        const stockText = totalStock > 50 ? 'In Stock' :
                                         totalStock > 10 ? 'Low Stock' :
                                         totalStock > 0 ? 'Very Low' : 'Out of Stock';

                        const actualPrice = product.actualPrice || 0;
                        const sellingPrice = product.sellingPrice || 0;

                        const productHtml = `
                            <div class="search-dropdown-item" data-id="${product.productId}" data-type="product">
                                <div class="flex justify-between items-start">
                                    <div class="flex-1">
                                        <div class="font-semibold text-[10px] text-gray-900">${product.name || 'No Name'}
                                            <span class="product-info-badge text-[7px]">${product.productCode || 'N/A'}</span>
                                        </div>
                                        <div class="text-[10px] text-gray-600 mt-1">
                                            ${product.brandName || 'No Brand'} • ${product.category ? product.category.name : 'No Category'}
                                        </div>
                                        <div class="mt-1">
                                            <span class="text-[10px] text-gray-500 ml-1">Cost Price: </span>
                                            <span class="text-xs font-bold text-blue-600">₹${actualPrice}</span>
                                            <span class="text-[10px] text-gray-500 ml-1">Selling Price: ₹${sellingPrice}</span>
                                        </div>
                                    </div>
                                    <div class="text-right ml-2">
                                        <span class="stock-indicator ${stockClass}">${stockText}</span>
                                        <div class="text-[10px] text-gray-600 mt-1">Stock: ${totalStock}</div>
                                    </div>
                                </div>
                            </div>
                        `;
                        dropdown.append(productHtml);
                    });
                }
                dropdown.show();
            }

            function selectSupplier(supplier) {
                $('#supplierSearch').val(supplier.name);
                $('#selectedSupplierId').val(supplier.id);
                $('#selectedSupplierName').text(`${supplier.name} (${supplier.email})`);
                $('#selectedSupplierInfo').show();
                $('#supplierDropdown').hide();
                updateDashboard();
                saveFormState();
            }

            function selectProduct(product, row) {
                row.find('.product-search').val(product.name);
                row.find('.product-id-input').val(product.productId);

                // Fill all product fields
                row.find('.product-name-input').val(product.name);
                row.find('.product-brand-input').val(product.brandName || '');
                row.find('.product-attribute-input').val(product.attribute || '');
                row.find('.product-description-input').val(product.description || '');
                row.find('.product-actual-price-input').val(product.actualPrice || 0);
                row.find('.product-selling-price-input').val(product.sellingPrice || 0);
                row.find('.product-discount-input').val(product.discount || 0);
                row.find('.product-category-select').val(product.category ? product.category.id : '');
                row.find('.product-lowstock-input').val(product.lowStockThreshold || 10);

                // Set purchase price to actual price by default
                row.find('.purchase-price-input').val(product.actualPrice || 0);

                // Show product details section but mark as existing product
                row.find('.product-details-section').addClass('show');
                row.find('.new-product-indicator').removeClass('show');

                calculateItemTotal(row);
                calculateGrandTotal();
                updateDashboard();
                row.find('.product-dropdown').hide();
            }

            $(document).on('click', '[data-type="supplier"]', function() {
                const id = $(this).data('id');
                const supplier = suppliers.find(s => s.id == id);
                if (supplier) selectSupplier(supplier);
            });

            $(document).on('click', '[data-type="product"]', function() {
                const id = $(this).data('id');
                const product = products.find(p => p.productId == id);
                const row = $(this).closest('.order-item-row');
                if (product) selectProduct(product, row);
            });

            function initializeModalFunctionality() {
                $('#createSupplierBtn').click(() => $('#supplierModal').show());

                $('.close-modal').click(function() {
                    const modal = $(this).closest('.modal');
                    modal.hide();
                    modal.find('form')[0].reset();
                });

                $('.modal').click(function(e) {
                    if (e.target === this) {
                        $(this).hide();
                        $(this).find('form')[0].reset();
                    }
                });

                $('#saveSupplier').click(saveSupplier);
            }

            function saveSupplier() {
                const formData = new FormData($('#supplierForm')[0]);
                const supplierData = Object.fromEntries(formData);
                const saveBtn = $('#saveSupplier');

                saveBtn.prop('disabled', true).text('Creating...');

                $.ajax({
                    url: '/orders/suppliers/create',
                    method: 'POST',
                    data: JSON.stringify(supplierData),
                    contentType: 'application/json',
                    success: function(response) {
                        let supplierObj = response.id ? response : {
                            id: Date.now(),
                            ...supplierData
                        };
                        suppliers.push(supplierObj);
                        selectSupplier(supplierObj);
                        showNotification('Supplier created successfully', 'success');
                        $('#supplierModal').hide();
                        $('#supplierForm')[0].reset();
                    },
                    error: function(xhr) {
                        showNotification('Failed to create supplier', 'error');
                    },
                    complete: function() {
                        saveBtn.prop('disabled', false).text('Create Supplier');
                    }
                });
            }

            function initializeOrderItems() {
                $('#addItemBtn').click(addOrderItem);

                $(document).on('input', '.quantity-input, .purchase-price-input', function() {
                    const row = $(this).closest('.order-item-row');
                    calculateItemTotal(row);
                    calculateGrandTotal();
                    updateDashboard();
                });

                $(document).on('click', '.remove-item-btn', function() {
                    const items = $('.order-item-row');
                    if (items.length > 1) {
                        $(this).closest('.order-item-row').remove();
                        updateItemIndexes();
                        calculateGrandTotal();
                        updateDashboard();
                    } else {
                        showNotification('At least one item is required', 'warning');
                    }
                });

                calculateGrandTotal();
                updateDashboard();
            }

            function addOrderItem() {
                const newItem = $(`
                    <div class="order-item-row">
                        <!-- New Product Indicator -->
                        <div class="new-product-indicator">
                            <i class="bi bi-exclamation-circle mr-2"></i>
                            New product will be created with the details below
                        </div>

                        <!-- Basic Product Search and Selection -->
                        <div class="form-grid form-grid-4 mb-4">
                            <div class="priority-field">
                                <label class="form-label">Product <span class="text-red-600">*</span></label>
                                <div class="search-container">
                                    <input type="text" class="input-field w-full product-search"
                                           placeholder="Search or enter new product..." autocomplete="off">
                                    <div class="search-dropdown product-dropdown" style="display: none;"></div>
                                    <input type="hidden" name="orderItems[${itemIndex}].productDto.productId" class="product-id-input">
                                </div>
                            </div>
                            <div class="priority-field">
                                <label class="form-label">Quantity <span class="text-red-600">*</span></label>
                                <input type="number" class="input-field w-full quantity-input"
                                       name="orderItems[${itemIndex}].quantity" min="1" value="1" required>
                            </div>
                            <div class="priority-field">
                                <label class="form-label">Purchase Price <span class="text-red-600">*</span></label>
                                <input type="number" class="input-field w-full purchase-price-input"
                                       name="orderItems[${itemIndex}].priceAtOrderTime" step="0.01" min="0" required
                                       placeholder="Enter purchase price">
                            </div>
                            <div>
                                <label class="form-label">Line Total</label>
                                <div class="item-total-display item-total">₹ 0.00</div>
                            </div>
                        </div>

                        <!-- Extended Product Details Section -->
                        <div class="product-details-section">
                            <h4 class="font-semibold text-gray-700 mb-3">Product Details</h4>

                            <!-- Priority Fields -->
                            <div class="form-grid form-grid-3 mb-3">
                                <div>
                                    <label class="form-label">Product Name <span class="text-red-600">*</span></label>
                                    <input type="text" class="input-field w-full product-name-input"
                                           name="orderItems[${itemIndex}].productDto.name" required
                                           placeholder="Enter product name">
                                </div>
                                <div>
                                    <label class="form-label">Brand Name <span class="text-red-600">*</span></label>
                                    <input type="text" class="input-field w-full product-brand-input"
                                           name="orderItems[${itemIndex}].productDto.brandName" required
                                           placeholder="Enter brand name">
                                </div>
                                <div>
                                    <label class="form-label">Category <span class="text-red-600">*</span></label>
                                    <select class="input-field w-full product-category-select"
                                            name="orderItems[${itemIndex}].productDto.category.id" required>
                                        <option value="">Select Category</option>
                                        ${categories.map(cat => `<option value="${cat.id}">${cat.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>

                            <!-- Pricing Fields -->
                            <div class="form-grid form-grid-3 mb-3">
                                <div>
                                    <label class="form-label">Actual Price (Cost) <span class="text-red-600">*</span></label>
                                    <input type="number" class="input-field w-full product-actual-price-input"
                                           name="orderItems[${itemIndex}].productDto.actualPrice" step="0.01" min="0" required
                                           placeholder="Cost price">
                                </div>
                                <div>
                                    <label class="form-label">Selling Price <span class="text-red-600">*</span></label>
                                    <input type="number" class="input-field w-full product-selling-price-input"
                                           name="orderItems[${itemIndex}].productDto.sellingPrice" step="0.01" min="0" required
                                           placeholder="Selling price">
                                </div>
                                <div>
                                    <label class="form-label">Discount (%)</label>
                                    <input type="number" class="input-field w-full product-discount-input"
                                           name="orderItems[${itemIndex}].productDto.discount" step="0.01" min="0" max="100"
                                           placeholder="0">
                                </div>
                            </div>

                            <!-- Secondary Fields -->
                            <div class="form-grid form-grid-3 mb-3">
                                <div>
                                    <label class="form-label">Attribute</label>
                                    <input type="text" class="input-field w-full product-attribute-input"
                                           name="orderItems[${itemIndex}].productDto.attribute"
                                           placeholder="e.g., Color: Red, Size: L">
                                </div>
                                <div>
                                    <label class="form-label">Low Stock Threshold</label>
                                    <input type="number" class="input-field w-full product-lowstock-input"
                                           name="orderItems[${itemIndex}].productDto.lowStockThreshold" min="0"
                                           placeholder="10" value="10">
                                </div>
                                <div>
                                    <label class="form-label">Description</label>
                                    <input type="text" class="input-field w-full product-description-input"
                                           name="orderItems[${itemIndex}].productDto.description"
                                           placeholder="Product description">
                                </div>
                            </div>

                            <!-- Set supplier for new product -->
                            <input type="hidden" name="orderItems[${itemIndex}].productDto.supplier.id" class="product-supplier-input">
                        </div>

                        <!-- Remove Button -->
                        <div class="flex justify-end mt-4">
                            <button type="button" class="btn-danger remove-item-btn">
                                <i class="bi bi-trash mr-1"></i>Remove Item
                            </button>
                        </div>
                    </div>
                `);

                $('#orderItems').append(newItem);

                // Set the supplier for new products
                const supplierId = $('#selectedSupplierId').val();
                if (supplierId) {
                    newItem.find('.product-supplier-input').val(supplierId);
                }

                itemIndex++;
                calculateGrandTotal();
                updateDashboard();
            }

            function updateItemIndexes() {
                $('.order-item-row').each(function(index) {
                    $(this).find('input[name*="orderItems"], select[name*="orderItems"]').each(function() {
                        const name = $(this).attr('name');
                        if (name) {
                            const newName = name.replace(/orderItems\[\d+\]/, `orderItems[${index}]`);
                            $(this).attr('name', newName);
                        }
                    });
                });
                itemIndex = $('.order-item-row').length;
            }

            function calculateItemTotal(row) {
                const quantity = parseFloat(row.find('.quantity-input').val()) || 0;
                const price = parseFloat(row.find('.purchase-price-input').val()) || 0;
                const total = quantity * price;
                row.find('.item-total').text(`₹ ${total.toFixed(2)}`);
            }

            function calculateGrandTotal() {
                let grandTotal = 0;
                $('.order-item-row').each(function() {
                    const quantity = parseFloat($(this).find('.quantity-input').val()) || 0;
                    const price = parseFloat($(this).find('.purchase-price-input').val()) || 0;
                    grandTotal += quantity * price;
                    calculateItemTotal($(this));
                });
                $('#totalPrice').text(grandTotal.toFixed(2));
            }

            function showNotification(message, type) {
                const alertClass = type === 'success' ? 'success-alert' :
                                  type === 'error' ? 'error-alert' : 'warning-alert';

                const notification = $(`
                    <div class="notification ${alertClass}">
                        <div class="flex items-center justify-between">
                            <div class="flex items-center">
                                <i class="bi ${type === 'success' ? 'bi-check-circle' :
                                              type === 'error' ? 'bi-exclamation-triangle' : 'bi-info-circle'} mr-2"></i>
                                <span class="font-semibold">${message}</span>
                            </div>
                            <button class="ml-3 text-white hover:text-gray-200" onclick="$(this).parent().parent().remove()">
                                <i class="bi bi-x text-lg"></i>
                            </button>
                        </div>
                    </div>
                `);

                $('body').append(notification);
                setTimeout(() => notification.fadeOut(() => notification.remove()), 5000);
            }

            function saveFormState() {
                const formState = {
                    paymentType: $('#paymentType').val(),
                    orderStatus: $('#orderStatus').val(),
                    selectedSupplierId: $('#selectedSupplierId').val(),
                    selectedSupplierName: $('#selectedSupplierName').text()
                };
                sessionStorage.setItem('purchaseOrderFormState', JSON.stringify(formState));
            }

            // Update supplier for all new products when supplier is selected
            $(document).on('change', '#selectedSupplierId', function() {
                const supplierId = $(this).val();
                $('.product-supplier-input').val(supplierId);
            });

            // Sync purchase price with actual price for new products
           $(document).on('input', '.product-actual-price-input, .purchase-price-input', function() {
                const row = $(this).closest('.order-item-row');
                const actualPriceInput = row.find('.product-actual-price-input');
                const purchasePriceInput = row.find('.purchase-price-input');

                // Determine which field was changed
                const isActualPriceChanged = $(this).hasClass('product-actual-price-input');
                const newValue = $(this).val();

                // Sync the other field
                if (isActualPriceChanged) {
                    purchasePriceInput.val(newValue);
                } else {
                    actualPriceInput.val(newValue);
                }

                // Add visual feedback (optional)
                const targetField = isActualPriceChanged ? purchasePriceInput : actualPriceInput;
                targetField.addClass('border-blue-400 bg-blue-50');
                setTimeout(() => {
                    targetField.removeClass('border-blue-400 bg-blue-50');
                }, 300);

                calculateItemTotal(row);
                calculateGrandTotal();
                updateDashboard();
            });

            $('#purchaseOrderForm').on('submit', function(e) {
                const hasValidSupplier = $('#selectedSupplierId').val();
                const hasValidItems = $('.product-search').filter(function() {
                    return $(this).val().trim() !== '';
                }).length > 0;

                if (!hasValidSupplier) {
                    e.preventDefault();
                    showNotification('Please select a supplier', 'error');
                    return false;
                }

                if (!hasValidItems) {
                    e.preventDefault();
                    showNotification('Please add at least one product to the order', 'error');
                    return false;
                }

                if (!$('#paymentType').val()) {
                    e.preventDefault();
                    showNotification('Please select a payment method', 'error');
                    return false;
                }

                sessionStorage.removeItem('purchaseOrderFormState');
                return true;
            });
        </script>
    </th:block>
    </body>
    </html>