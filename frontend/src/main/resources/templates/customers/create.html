<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{_layout}">

<head>
    <title>Create Customer - CRM Dashboard</title>
    <style>
        .form-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.95) 100%);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        .form-card:hover {
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15);
        }
        .input-group {
            position: relative;
            transition: all 0.3s ease;
        }
        .input-field {
            transition: all 0.3s ease;
            border: 2px solid #e5e7eb;
        }
        .input-field:focus {
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            transform: translateY(-1px);
        }
        .input-field.error {
            border-color: #ef4444;
            background-color: #fef2f2;
        }
        .input-field.success {
            border-color: #10b981;
            background-color: #f0fdf4;
        }
        .floating-label {
            position: absolute;
            left: 12px;
            top: 12px;
            background: white;
            padding: 0 4px;
            color: #6b7280;
            transition: all 0.3s ease;
            pointer-events: none;
        }
        .input-field:focus + .floating-label,
        .input-field:not(:placeholder-shown) + .floating-label {
            top: -8px;
            font-size: 0.75rem;
            color: #3b82f6;
            font-weight: 600;
        }
        .btn-primary {
            background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
            transition: all 0.3s ease;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(59, 130, 246, 0.4);
        }
        .btn-secondary {
            background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
            transition: all 0.3s ease;
        }
        .btn-secondary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(107, 114, 128, 0.3);
        }
        .alert-success {
            background: linear-gradient(135deg, #10b981 0%, #34d399 100%);
            border: none;
            color: white;
        }
        .alert-error {
            background: linear-gradient(135deg, #ef4444 0%, #f87171 100%);
            border: none;
            color: white;
        }
        .page-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .form-progress {
            background: linear-gradient(90deg, #3b82f6 0%, #8b5cf6 100%);
            height: 4px;
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        .validation-icon {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            transition: all 0.3s ease;
        }
        .character-count {
            font-size: 0.75rem;
            color: #6b7280;
            text-align: right;
            margin-top: 4px;
        }
        .form-tips {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1) 0%, rgba(139, 92, 246, 0.1) 100%);
            border-left: 4px solid #3b82f6;
        }
    </style>
</head>

<body>
<div layout:fragment="content">
    <!-- Flash Messages -->
    <div th:if="${success}" class="alert-success rounded-2xl p-4 mb-6 shadow-lg">
        <div class="flex items-center">
            <i class="bi bi-check-circle-fill mr-3 text-xl"></i>
            <span th:text="${success}"></span>
        </div>
    </div>
    <div th:if="${error}" class="alert-error rounded-2xl p-4 mb-6 shadow-lg">
        <div class="flex items-center">
            <i class="bi bi-exclamation-triangle-fill mr-3 text-xl"></i>
            <span th:text="${error}"></span>
        </div>
    </div>

    <!-- Enhanced Header -->
    <div class="mb-8 page-header rounded-2xl p-6 text-white shadow-xl">
        <div class="flex flex-col lg:flex-row lg:justify-between lg:items-center gap-4">
            <div>
                <h1 class="text-3xl font-bold">Create New Customer</h1>
                <p class="mt-2 text-white/80">Add a new customer to your CRM system and start building relationships</p>
            </div>
            <div>
                <a href="/customers"
                   class="inline-flex items-center px-6 py-3 border-2 border-white/20 text-sm font-medium rounded-xl shadow-lg text-white bg-white/20 backdrop-blur-sm hover:bg-white/30 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-white/50 transition-all duration-300">
                    <i class="bi bi-arrow-left mr-2"></i>Back to Customers
                </a>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="mt-6 bg-white/20 rounded-full h-2">
            <div id="formProgress" class="form-progress w-0"></div>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <!-- Main Form -->
        <div class="lg:col-span-2">
            <div class="form-card rounded-2xl shadow-xl overflow-hidden">
                <div class="px-8 py-6 border-b border-gray-200/50 bg-gradient-to-r from-gray-50/50 to-white/50">
                    <h3 class="text-xl font-semibold text-gray-900">Customer Information</h3>
                    <p class="mt-1 text-sm text-gray-600">Please provide accurate information for the new customer</p>
                </div>

                <div class="px-8 py-8">
                    <form th:action="@{/customers/create}" th:object="${customer}" method="post" class="space-y-8" id="customerForm">
                        <!-- Personal Information Section -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-6 flex items-center">
                                <i class="bi bi-person-circle mr-2 text-blue-600"></i>
                                Personal Information
                            </h4>

                            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                <!-- Name Field -->
                                <div class="input-group">
                                    <input type="text"
                                           id="name"
                                           th:field="*{name}"
                                           required
                                           placeholder=" "
                                           maxlength="100"
                                           class="input-field block w-full px-4 py-3 rounded-xl text-sm focus:outline-none"
                                           th:classappend="${#fields.hasErrors('name')} ? 'error' : ''">
                                    <label for="name" class="floating-label">
                                        Customer Name <span class="text-red-500">*</span>
                                    </label>
                                    <div class="validation-icon">
                                        <i th:if="${#fields.hasErrors('name')}" class="bi bi-exclamation-circle text-red-500"></i>
                                        <i th:unless="${#fields.hasErrors('name')}" class="bi bi-check-circle text-green-500 hidden" id="nameCheck"></i>
                                    </div>
                                    <div class="character-count">
                                        <span id="nameCount">0</span>/100 characters
                                    </div>
                                    <p th:if="${#fields.hasErrors('name')}" class="mt-2 text-sm text-red-600 flex items-center">
                                        <i class="bi bi-exclamation-triangle mr-1"></i>
                                        <span th:errors="*{name}"></span>
                                    </p>
                                </div>

                                <!-- Email Field -->
                                <div class="input-group">
                                    <input type="email"
                                           id="email"
                                           th:field="*{email}"
                                           required
                                           placeholder=" "
                                           class="input-field block w-full px-4 py-3 rounded-xl text-sm focus:outline-none"
                                           th:classappend="${#fields.hasErrors('email')} ? 'error' : ''">
                                    <label for="email" class="floating-label">
                                        Email Address <span class="text-red-500">*</span>
                                    </label>
                                    <div class="validation-icon">
                                        <i th:if="${#fields.hasErrors('email')}" class="bi bi-exclamation-circle text-red-500"></i>
                                        <i th:unless="${#fields.hasErrors('email')}" class="bi bi-check-circle text-green-500 hidden" id="emailCheck"></i>
                                    </div>
                                    <p th:if="${#fields.hasErrors('email')}" class="mt-2 text-sm text-red-600 flex items-center">
                                        <i class="bi bi-exclamation-triangle mr-1"></i>
                                        <span th:errors="*{email}"></span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Contact Information Section -->
                        <div>
                            <h4 class="text-lg font-medium text-gray-900 mb-6 flex items-center">
                                <i class="bi bi-telephone mr-2 text-blue-600"></i>
                                Contact Information
                            </h4>

                            <div class="grid grid-cols-1 gap-6 sm:grid-cols-2">
                                <!-- Contact Number Field -->
                                <div class="input-group">
                                    <input type="tel"
                                           id="contactNumber"
                                           th:field="*{contactNumber}"
                                           required
                                           placeholder=" "
                                           class="input-field block w-full px-4 py-3 rounded-xl text-sm focus:outline-none"
                                           th:classappend="${#fields.hasErrors('contactNumber')} ? 'error' : ''">
                                    <label for="contactNumber" class="floating-label">
                                        Contact Number <span class="text-red-500">*</span>
                                    </label>
                                    <div class="validation-icon">
                                        <i th:if="${#fields.hasErrors('contactNumber')}" class="bi bi-exclamation-circle text-red-500"></i>
                                        <i th:unless="${#fields.hasErrors('contactNumber')}" class="bi bi-check-circle text-green-500 hidden" id="phoneCheck"></i>
                                    </div>
                                    <p th:if="${#fields.hasErrors('contactNumber')}" class="mt-2 text-sm text-red-600 flex items-center">
                                        <i class="bi bi-exclamation-triangle mr-1"></i>
                                        <span th:errors="*{contactNumber}"></span>
                                    </p>
                                    <p class="mt-1 text-xs text-gray-500">Format: +1 (555) 123-4567 or +91 98765 43210</p>
                                </div>

                                <!-- Address Field -->
                                <div class="input-group">
                                    <textarea id="address"
                                              th:field="*{address}"
                                              rows="3"
                                              placeholder=" "
                                              maxlength="500"
                                              class="input-field block w-full px-4 py-3 rounded-xl text-sm focus:outline-none resize-none"
                                              th:classappend="${#fields.hasErrors('address')} ? 'error' : ''"></textarea>
                                    <label for="address" class="floating-label">Address (Optional)</label>
                                    <div class="character-count">
                                        <span id="addressCount">0</span>/500 characters
                                    </div>
                                    <p th:if="${#fields.hasErrors('address')}" class="mt-2 text-sm text-red-600 flex items-center">
                                        <i class="bi bi-exclamation-triangle mr-1"></i>
                                        <span th:errors="*{address}"></span>
                                    </p>
                                </div>
                            </div>
                        </div>

                        <!-- Form Actions -->
                        <div class="flex flex-col sm:flex-row items-center justify-end pt-8 space-y-3 sm:space-y-0 sm:space-x-4 border-t border-gray-200">
                            <a href="/customers"
                               class="btn-secondary w-full sm:w-auto inline-flex items-center justify-center px-6 py-3 border border-transparent text-sm font-medium rounded-xl text-white shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-gray-500 transition-all duration-300">
                                <i class="bi bi-x-circle mr-2"></i>Cancel
                            </a>
                            <button type="submit"
                                    id="submitBtn"
                                    class="btn-primary w-full sm:w-auto inline-flex items-center justify-center px-8 py-3 border border-transparent text-sm font-medium rounded-xl text-white shadow-lg hover:shadow-xl focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-all duration-300">
                                <i class="bi bi-save mr-2"></i>
                                <span id="submitText">Create Customer</span>
                            </button>
                        </div>

                        <!-- Quick Actions -->
                        <div class="border-t border-gray-200 pt-6">
                            <h5 class="text-sm font-medium text-gray-700 mb-3">After creating customer:</h5>
                            <div class="flex flex-wrap gap-2">
                                <label class="inline-flex items-center">
                                    <input type="radio" name="redirect" value="customers" checked class="form-radio text-blue-600">
                                    <span class="ml-2 text-sm text-gray-600">View all customers</span>
                                </label>
                                <label class="inline-flex items-center">
                                    <input type="radio" name="redirect" value="orders" class="form-radio text-blue-600">
                                    <span class="ml-2 text-sm text-gray-600">Create an order for this customer</span>
                                </label>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Sidebar Information -->
        <div class="lg:col-span-1 space-y-6">
            <!-- Tips Card -->
            <div class="form-tips rounded-2xl p-6 shadow-lg">
                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="bi bi-lightbulb mr-2 text-yellow-500"></i>
                    Tips for Success
                </h4>
                <ul class="space-y-3 text-sm text-gray-600">
                    <li class="flex items-start">
                        <i class="bi bi-check-circle text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                        Use the customer's full legal name for formal communications
                    </li>
                    <li class="flex items-start">
                        <i class="bi bi-check-circle text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                        Double-check email addresses to avoid delivery issues
                    </li>
                    <li class="flex items-start">
                        <i class="bi bi-check-circle text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                        Include country code for international phone numbers
                    </li>
                    <li class="flex items-start">
                        <i class="bi bi-check-circle text-green-500 mr-2 mt-0.5 flex-shrink-0"></i>
                        Complete address helps with delivery and billing
                    </li>
                </ul>
            </div>

            <!-- Stats Card -->
            <div class="bg-white/80 backdrop-blur-sm rounded-2xl p-6 shadow-lg border border-white/20">
                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="bi bi-graph-up mr-2 text-blue-600"></i>
                    Quick Stats
                </h4>
                <div class="space-y-4">
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">Total Customers</span>
                        <span class="text-sm font-semibold text-blue-600" th:text="${totalCustomers}">Loading...</span>
                    </div>
                    <div class="flex justify-between items-center">
                        <span class="text-sm text-gray-600">New This Month</span>
                        <span class="text-sm font-semibold text-green-600" th:text="${newCustomerThisMonth}">Loading...</span>
                    </div>
<!--                    <div class="flex justify-between items-center">-->
<!--                        <span class="text-sm text-gray-600">Average Orders</span>-->
<!--                        <span class="text-sm font-semibold text-purple-600">Loading...</span>-->
<!--                    </div>-->
                </div>
            </div>

            <!-- Next Steps Card -->
            <div class="bg-gradient-to-br from-blue-50 to-purple-50 rounded-2xl p-6 shadow-lg border border-blue-100">
                <h4 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                    <i class="bi bi-arrow-right-circle mr-2 text-blue-600"></i>
                    What's Next?
                </h4>
                <div class="space-y-3 text-sm">
                    <div class="flex items-center text-gray-600">
                        <i class="bi bi-1-circle mr-2 text-blue-500"></i>
                        Customer profile will be created
                    </div>
                    <div class="flex items-center text-gray-600">
                        <i class="bi bi-2-circle mr-2 text-blue-500"></i>
                        You can create orders immediately
                    </div>
                    <div class="flex items-center text-gray-600">
                        <i class="bi bi-3-circle mr-2 text-blue-500"></i>
                        Track customer history and analytics
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<th:block layout:fragment="scripts">
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const form = document.getElementById('customerForm');
            const nameInput = document.getElementById('name');
            const emailInput = document.getElementById('email');
            const phoneInput = document.getElementById('contactNumber');
            const addressInput = document.getElementById('address');
            const submitBtn = document.getElementById('submitBtn');
            const submitText = document.getElementById('submitText');
            const formProgress = document.getElementById('formProgress');

            // Character counters
            function updateCharacterCount(input, counterId) {
                const counter = document.getElementById(counterId);
                const length = input.value.length;
                counter.textContent = length;

                if (counterId === 'nameCount') {
                    counter.style.color = length > 80 ? '#ef4444' : '#6b7280';
                } else if (counterId === 'addressCount') {
                    counter.style.color = length > 400 ? '#ef4444' : '#6b7280';
                }
            }

            nameInput.addEventListener('input', function() {
                updateCharacterCount(this, 'nameCount');
                validateField(this, 'nameCheck');
                updateFormProgress();
            });

            addressInput.addEventListener('input', function() {
                updateCharacterCount(this, 'addressCount');
                updateFormProgress();
            });

            // Real-time validation
            function validateField(input, checkIconId) {
                const checkIcon = document.getElementById(checkIconId);
                let isValid = false;

                if (input.id === 'name') {
                    isValid = input.value.trim().length >= 2;
                } else if (input.id === 'email') {
                    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                    isValid = emailRegex.test(input.value);
                } else if (input.id === 'contactNumber') {
                    const phoneRegex = /^[+]?[0-9\s\-\(\)]{10,15}$/;
                    isValid = phoneRegex.test(input.value);
                }

                if (isValid) {
                    input.classList.remove('error');
                    input.classList.add('success');
                    checkIcon.classList.remove('hidden');
                } else {
                    input.classList.remove('success');
                    checkIcon.classList.add('hidden');
                }
            }

            emailInput.addEventListener('input', function() {
                validateField(this, 'emailCheck');
                updateFormProgress();
            });

            phoneInput.addEventListener('input', function() {
                validateField(this, 'phoneCheck');
                updateFormProgress();
            });

            // Update form progress
            function updateFormProgress() {
                const fields = [nameInput, emailInput, phoneInput];
                const completed = fields.filter(field => field.value.trim().length > 0).length;
                const progress = (completed / fields.length) * 100;
                formProgress.style.width = progress + '%';
            }

            // Form submission
            form.addEventListener('submit', function(e) {
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-75', 'cursor-not-allowed');
                submitText.innerHTML = '<i class="bi bi-hourglass mr-2"></i>Creating...';

                // Re-enable after 10 seconds to prevent permanent disable on error
                setTimeout(function() {
                    submitBtn.disabled = false;
                    submitBtn.classList.remove('opacity-75', 'cursor-not-allowed');
                    submitText.innerHTML = '<i class="bi bi-save mr-2"></i>Create Customer';
                }, 10000);
            });

            // Phone number formatting
            phoneInput.addEventListener('input', function() {
                let value = this.value.replace(/\D/g, '');
                if (value.length >= 10) {
                    if (value.startsWith('91') && value.length === 12) {
                        // Indian format: +91 XXXXX XXXXX
                        value = '+91 ' + value.slice(2, 7) + ' ' + value.slice(7);
                    } else if (value.length === 10) {
                        // US format: (XXX) XXX-XXXX
                        value = '(' + value.slice(0, 3) + ') ' + value.slice(3, 6) + '-' + value.slice(6);
                    }
                    this.value = value;
                }
            });

            // Auto-hide flash messages
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert-success, .alert-error');
                alerts.forEach(function(alert) {
                    alert.style.transition = 'opacity 0.5s ease-out';
                    alert.style.opacity = '0';
                    setTimeout(function() {
                        alert.remove();
                    }, 500);
                });
            }, 5000);

            // Initialize character counts
            updateCharacterCount(nameInput, 'nameCount');
            updateCharacterCount(addressInput, 'addressCount');
            updateFormProgress();
        });
    </script>
</th:block>
</body>
</html>